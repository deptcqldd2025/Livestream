<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety Live - V1.4</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        /* VIDEO LAYER */
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* G∆∞∆°ng cho gi·ªëng soi g∆∞∆°ng */ }
        /* Camera sau th√¨ kh√¥ng l·∫≠t g∆∞∆°ng */
        .rear-cam { transform: scaleX(1) !important; }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* DEBUG CONSOLE */
        #debug-box {
            position: absolute; top: 60px; left: 10px; width: 200px; max-height: 150px;
            overflow-y: auto; background: rgba(0,0,0,0.6); color: #0f0;
            font-size: 10px; font-family: monospace; padding: 5px; pointer-events: none;
            border-left: 2px solid #0f0; display: none; /* ·∫®n m·∫∑c ƒë·ªãnh, b·∫≠t trong code n·∫øu c·∫ßn */
        }

        /* ELEMENTS */
        .top-bar { background: rgba(0,0,0,0.5); padding: 15px; color: white; display: flex; justify-content: space-between; pointer-events: auto; }
        
        .status-badge {
            align-self: center; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; font-size: 1.2rem; text-transform: uppercase;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto;
            transition: all 0.3s ease;
        }
        .st-wait { background: #ffc107; color: #000; }
        .st-safe { background: #28a745; color: white; transform: scale(1.1); }
        .st-danger { background: #dc3545; color: white; animation: blink 0.5s infinite alternate; }
        
        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

        .bottom-controls { background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; pointer-events: auto; }
        
        .btn-action { height: 60px; font-weight: bold; font-size: 1.1rem; width: 100%; border-radius: 12px; }
        
        .hidden { display: none !important; }

        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 class="mb-4 fw-bold text-primary"><i class="fas fa-shield-alt"></i> SAFETY CHECK</h2>
        <div class="d-grid gap-3 col-10 col-md-4">
            <button class="btn btn-primary btn-lg py-3 shadow" onclick="initApp('streamer')">
                <i class="fas fa-video"></i> ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG
            </button>
            <button class="btn btn-dark btn-lg py-3 shadow" onclick="initApp('viewer')">
                <i class="fas fa-user-secret"></i> GI√ÅM S√ÅT VI√äN
            </button>
        </div>
        <p class="mt-4 text-muted small">Project: livestream-2e250</p>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden rear-cam"></video>
            <video id="local-video" autoplay playsinline muted class="hidden rear-cam"></video>
        </div>

        <div id="debug-box">System Logs:<br></div>

        <div id="ui-layer">
            <div class="top-bar">
                <span id="role-display" class="fw-bold">...</span>
                <button class="btn btn-sm btn-light" onclick="location.reload()"><i class="fas fa-redo"></i> Reset</button>
            </div>

            <div id="status-display" class="status-badge st-wait">
                ƒêang k·∫øt n·ªëi...
            </div>

            <div class="bottom-controls">
                <div id="viewer-controls" class="row g-2 hidden">
                    <div class="col-6">
                        <button class="btn btn-danger btn-action shadow" onclick="setSafetyStatus('danger')">
                            <i class="fas fa-times-circle"></i> C·∫¢NH B√ÅO
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-success btn-action shadow" onclick="setSafetyStatus('safe')">
                            <i class="fas fa-check-circle"></i> X√ÅC NH·∫¨N
                        </button>
                    </div>
                </div>

                <div id="streamer-controls" class="hidden">
                    <button id="btn-start-work" class="btn btn-secondary btn-action shadow" disabled onclick="confirmWork()">
                        <i class="fas fa-lock"></i> CH·ªú DUY·ªÜT ƒê·ªÇ B·∫ÆT ƒê·∫¶U
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG M·ªöI (Project: livestream-2e250) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294",
            measurementId: "G-FTJYJ89SZH"
        };

        const ROOM_ID = "VDC_WORK_ROOM_01"; // C√≥ th·ªÉ ƒë·ªïi theo t·ª´ng phi√™n l√†m vi·ªác

        // --- 2. KH·ªûI T·∫†O ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let peer;
        let myStream;
        let role = '';

        // Hi·ªÉn th·ªã log ƒë·ªÉ debug (B·∫≠t l√™n n·∫øu c·∫ßn check l·ªói)
        function log(msg) {
            const box = document.getElementById('debug-box');
            box.style.display = 'block';
            box.innerHTML += `> ${msg}<br>`;
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }

        function initApp(selectedRole) {
            role = selectedRole;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('role-display').innerText = role === 'streamer' ? "üé• HI·ªÜN TR∆Ø·ªúNG" : "üõ°Ô∏è GI√ÅM S√ÅT";

            listenSafetyStatus(); // Lu√¥n l·∫Øng nghe l·ªánh

            if (role === 'streamer') {
                setupStreamer();
            } else {
                setupViewer();
            }
        }

        // --- 3. LOGIC HI·ªÜN TR∆Ø·ªúNG (STREAMER) ---
        async function setupStreamer() {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-controls').classList.remove('hidden');

            try {
                log("ƒêang m·ªü Camera...");
                // ∆Øu ti√™n camera sau (environment)
                myStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = myStream;

                log("K·∫øt n·ªëi m√°y ch·ªß Peer...");
                // S·ª≠ d·ª•ng Google STUN server mi·ªÖn ph√≠ ƒë·ªÉ xuy√™n t∆∞·ªùng l·ª≠a 3G/4G
                peer = new Peer({
                    config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
                });

                peer.on('open', (id) => {
                    log("ID c·ªßa t√¥i: " + id);
                    log("ƒêang g·ª≠i ID l√™n Firebase...");
                    
                    // Ghi ID v√†o Database ƒë·ªÉ Gi√°m s√°t t√¨m th·∫•y
                    db.ref('sessions/' + ROOM_ID).update({
                        streamerID: id,
                        isOnline: true,
                        lastUpdate: Date.now()
                    }, (error) => {
                        if (error) {
                            alert("L·ªñI: Ch∆∞a m·ªü quy·ªÅn Database! H√£y v√†o Console ch·ªânh Rules.");
                            log("Permission Denied!");
                        } else {
                            log("ƒê√£ ph√°t t√≠n hi·ªáu OK!");
                        }
                    });
                });

                peer.on('call', (call) => {
                    log("Gi√°m s√°t ƒëang xem...");
                    call.answer(myStream);
                });

            } catch (err) {
                alert("L·ªói Camera: " + err.message);
            }
        }

        // --- 4. LOGIC GI√ÅM S√ÅT (VIEWER) ---
        function setupViewer() {
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-controls').classList.remove('hidden');

            peer = new Peer(); // Viewer d√πng ID ng·∫´u nhi√™n

            peer.on('open', () => {
                log("Viewer s·∫µn s√†ng. T√¨m Streamer...");
                
                // L·∫Øng nghe thay ƒë·ªïi tr√™n Firebase ƒë·ªÉ l·∫•y ID Streamer
                db.ref('sessions/' + ROOM_ID).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.streamerID) {
                        log("T√¨m th·∫•y Streamer: " + data.streamerID);
                        connectToStreamer(data.streamerID);
                    } else {
                        log("Ch·ªù Streamer online...");
                    }
                });
            });
        }

        let currentCall = null;
        function connectToStreamer(streamerId) {
            if (currentCall) return; // ƒê√£ g·ªçi r·ªìi th√¨ th√¥i

            log("ƒêang g·ªçi video...");
            // G·ªçi Streamer (ch·ªâ nh·∫≠n h√¨nh, kh√¥ng g·ª≠i h√¨nh m√¨nh ƒëi)
            const call = peer.call(streamerId, navigator.mediaDevices.getUserMedia ? null : null);
            currentCall = call;

            call.on('stream', (remoteStream) => {
                log("ƒê√£ nh·∫≠n VIDEO!");
                const vid = document.getElementById('remote-video');
                vid.srcObject = remoteStream;
                // Fix l·ªói tr√¨nh duy·ªát ch·∫∑n autoplay
                vid.play().catch(() => log("Vui l√≤ng ch·∫°m m√†n h√¨nh ƒë·ªÉ ph√°t video"));
            });
            
            call.on('error', (err) => log("L·ªói g·ªçi: " + err));
        }

        // --- 5. LOGIC AN TO√ÄN (REALTIME DATABASE) ---
        
        function setSafetyStatus(status) {
            // Gi√°m s√°t g·ª≠i l·ªánh
            db.ref('sessions/' + ROOM_ID + '/safety').set(status);
        }

        function listenSafetyStatus() {
            const badge = document.getElementById('status-display');
            const btnWork = document.getElementById('btn-start-work');

            db.ref('sessions/' + ROOM_ID + '/safety').on('value', (snap) => {
                const status = snap.val() || 'waiting';
                
                // Reset class
                badge.className = 'status-badge';

                if (status === 'waiting') {
                    badge.innerText = "‚è≥ CH·ªú KI·ªÇM TRA";
                    badge.classList.add('st-wait');
                    
                    btnWork.disabled = true;
                    btnWork.innerHTML = '<i class="fas fa-lock"></i> CH·ªú DUY·ªÜT ƒê·ªÇ B·∫ÆT ƒê·∫¶U';
                    btnWork.classList.replace('btn-primary', 'btn-secondary');
                } 
                else if (status === 'safe') {
                    badge.innerText = "‚úÖ AN TO√ÄN - ƒê∆Ø·ª¢C PH√âP";
                    badge.classList.add('st-safe');

                    btnWork.disabled = false;
                    btnWork.innerHTML = '<i class="fas fa-tools"></i> B·∫ÆT ƒê·∫¶U L√ÄM VI·ªÜC';
                    btnWork.classList.replace('btn-secondary', 'btn-primary');
                } 
                else if (status === 'danger') {
                    badge.innerText = "‚õî NGUY HI·ªÇM - D·ª™NG L·∫†I";
                    badge.classList.add('st-danger');

                    btnWork.disabled = true;
                    btnWork.innerHTML = '<i class="fas fa-exclamation-triangle"></i> D·ª™NG L·∫†I NGAY!';
                    btnWork.classList.replace('btn-primary', 'btn-secondary');
                    
                    // Rung ƒëi·ªán tho·∫°i c·∫£nh b√°o
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
                }
            });
        }

        function confirmWork() {
            if(confirm("X√°c nh·∫≠n b·∫Øt ƒë·∫ßu c√¥ng vi·ªác l√∫c " + new Date().toLocaleTimeString() + "?")) {
                alert("ƒê√£ ghi nh·∫≠n b·∫Øt ƒë·∫ßu!");
                // T·∫°i ƒë√¢y c√≥ th·ªÉ code th√™m g·ª≠i log l√™n Server l∆∞u tr·ªØ
            }
        }

    </script>
</body>
</html>
