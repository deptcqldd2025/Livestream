<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety Check V2.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .top-bar { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 15px; color: white; display: flex; justify-content: space-between; pointer-events: auto; 
        }

        .room-tag {
            background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;
        }
        
        .status-badge { 
            padding: 10px 30px; border-radius: 50px; font-weight: 900; letter-spacing: 1px;
            background: #fff; color: #000; align-self: center; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); transform: scale(0.9); transition: all 0.3s;
        }
        .st-safe { background: #00C851; color: white; transform: scale(1.1); border: 2px solid white; }
        .st-danger { background: #ff4444; color: white; animation: pulse 0.5s infinite; }

        .bottom-controls { background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; pointer-events: auto; }
        
        .btn-xl { height: 60px; font-size: 1.1rem; font-weight: bold; border-radius: 12px; }
        .hidden { display: none !important; }

        /* M√†n h√¨nh ch·ª•p ·∫£nh b·∫±ng ch·ª©ng */
        #snapshot-preview {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #snapshot-img { max-width: 90%; max-height: 70%; border: 3px solid #fff; border-radius: 8px; }

        #setup-screen {
            position: fixed; z-index: 9999; background: #f8f9fa; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 class="mb-2 text-primary fw-bold">VDC SAFETY LINK</h2>
        <div class="input-group mb-4 w-75 shadow-sm">
            <span class="input-group-text bg-white"><i class="fas fa-map-marker-alt"></i></span>
            <input type="text" id="room-input" class="form-control form-control-lg" placeholder="Nh·∫≠p t√™n tr·∫°m/t·ªï...">
        </div>
        
        <button class="btn btn-primary btn-lg mb-3 w-100 shadow" onclick="initApp('streamer')">
            <i class="fas fa-video"></i> T√îI L√Ä ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG
        </button>
        <button class="btn btn-dark btn-lg w-100 shadow" onclick="initApp('viewer')">
            <i class="fas fa-user-shield"></i> T√îI L√Ä GI√ÅM S√ÅT
        </button>
        <p class="mt-4 text-muted small">V2.0 - Production Ready</p>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <div id="ui-layer">
            <div class="top-bar">
                <div>
                    <div id="role-lbl" class="fw-bold">...</div>
                    <div id="room-lbl" class="room-tag mt-1">...</div>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Tho√°t</button>
            </div>
            
            <div id="status-badge" class="status-badge">ƒêang k·∫øt n·ªëi...</div>

            <div class="bottom-controls">
                <div id="viewer-btns" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger btn-xl shadow" onclick="confirmAction('danger')">C·∫¢NH B√ÅO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-xl shadow" onclick="confirmAction('safe')">X√ÅC NH·∫¨N</button></div>
                </div>
                <div id="streamer-btns" class="hidden">
                    <button id="btn-work" class="btn btn-secondary btn-xl w-100 shadow" disabled>CH·ªú DUY·ªÜT ƒê·ªÇ B·∫ÆT ƒê·∫¶U</button>
                </div>
            </div>
        </div>
    </div>

    <div id="snapshot-preview" class="hidden">
        <h4 class="text-white mb-3">üì∏ B·∫∞NG CH·ª®NG ƒê√É L∆ØU</h4>
        <img id="snapshot-img" src="" alt="Proof">
        <div class="text-white mt-2 small" id="snap-time"></div>
        <button class="btn btn-primary mt-4 px-5" onclick="closeSnapshot()">ƒê√≥ng</button>
    </div>

    <script>
        // === CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294",
            measurementId: "G-FTJYJ89SZH"
        };

        // === INIT ===
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let peer, role = '', ROOM_ID = '';

        // T·ª± ƒë·ªông l·∫•y ID t·ª´ URL (VD: index.html?id=TRAM1)
        const urlParams = new URLSearchParams(window.location.search);
        const urlID = urlParams.get('id');
        if(urlID) document.getElementById('room-input').value = urlID;

        function initApp(r) {
            const inputID = document.getElementById('room-input').value.trim();
            if(!inputID) return alert("Vui l√≤ng nh·∫≠p t√™n Tr·∫°m/T·ªï l√†m vi·ªác!");
            
            // Format ID ƒë·ªÉ tr√°nh k√Ω t·ª± l·∫°
            ROOM_ID = "VDC_" + inputID.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            role = r;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('role-lbl').innerText = role === 'streamer' ? "üé• ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG" : "üõ°Ô∏è GI√ÅM S√ÅT VI√äN";
            document.getElementById('room-lbl').innerText = "ID: " + inputID;

            listenSig();

            // WebRTC Config (STUN Google)
            const peerConfig = { config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } };
            
            if (role === 'streamer') startStreamer(peerConfig);
            else startViewer(peerConfig);
        }

        // === CORE LOGIC ===
        async function startStreamer(config) {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-btns').classList.remove('hidden');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = stream;

                peer = new Peer(config);
                peer.on('open', id => {
                    db.ref('vdc_ops/' + ROOM_ID).update({ streamerID: id, active: true });
                });
                peer.on('call', call => call.answer(stream));
            } catch (e) { alert("L·ªói Camera: " + e.message); }
        }

        function startViewer(config) {
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-btns').classList.remove('hidden');

            peer = new Peer(config);
            peer.on('open', () => {
                db.ref('vdc_ops/' + ROOM_ID).on('value', snap => {
                    const d = snap.val();
                    if (d && d.streamerID) connect(d.streamerID);
                });
            });
        }

        let currCall;
        function connect(id) {
            if (currCall) return;
            // Dummy Stream trick (B·∫Øt bu·ªôc ƒë·ªÉ xuy√™n NAT)
            const canvas = document.createElement('canvas'); canvas.width=10; canvas.height=10;
            const dummy = canvas.captureStream(30);
            
            const call = peer.call(id, dummy);
            currCall = call;

            call.on('stream', stream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = stream;
                vid.play().catch(() => { /* Auto play block handling if needed */ });
            });
        }

        // === SAFETY & EVIDENCE ===
        function confirmAction(type) {
            if(type === 'safe') {
                if(confirm("X√ÅC NH·∫¨N AN TO√ÄN?\nH·ªá th·ªëng s·∫Ω ch·ª•p ·∫£nh m√†n h√¨nh l√†m b·∫±ng ch·ª©ng.")) {
                    takeSnapshot(); // Ch·ª•p ·∫£nh tr∆∞·ªõc
                    db.ref('vdc_ops/' + ROOM_ID + '/status').set('safe');
                }
            } else {
                db.ref('vdc_ops/' + ROOM_ID + '/status').set('danger');
            }
        }

        function listenSig() {
            const badge = document.getElementById('status-badge');
            const btn = document.getElementById('btn-work');

            db.ref('vdc_ops/' + ROOM_ID + '/status').on('value', snap => {
                const s = snap.val() || 'waiting';
                
                // Reset styling
                badge.className = 'status-badge'; 
                
                if(s === 'safe') {
                    badge.innerText = "‚úÖ ƒê√É DUY·ªÜT AN TO√ÄN";
                    badge.classList.add('st-safe');
                    btn.disabled = false;
                    btn.innerText = "B·∫ÆT ƒê·∫¶U C√îNG VI·ªÜC";
                    btn.className = "btn btn-primary btn-xl w-100 shadow";
                } else if (s === 'danger') {
                    badge.innerText = "‚õî D·ª™NG L·∫†I NGAY";
                    badge.classList.add('st-danger');
                    btn.disabled = true;
                    btn.innerText = "NGUY HI·ªÇM!";
                    btn.className = "btn btn-secondary btn-xl w-100 shadow";
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                } else {
                    badge.innerText = "‚è≥ CH·ªú KI·ªÇM TRA";
                    btn.disabled = true;
                }
            });
        }

        // === SNAPSHOT FEATURE ===
        function takeSnapshot() {
            const vid = document.getElementById('remote-video');
            const canvas = document.createElement('canvas');
            canvas.width = vid.videoWidth;
            canvas.height = vid.videoHeight;
            canvas.getContext('2d').drawImage(vid, 0, 0);
            
            const dataURL = canvas.toDataURL('image/png');
            
            // Hi·ªÉn th·ªã Preview
            document.getElementById('snapshot-img').src = dataURL;
            document.getElementById('snap-time').innerText = "Th·ªùi gian: " + new Date().toLocaleString();
            document.getElementById('snapshot-preview').classList.remove('hidden');

            // TODO: ·ªû b∆∞·ªõc n√†y c√≥ th·ªÉ code th√™m upload ·∫£nh l√™n Firebase Storage n·∫øu c·∫ßn
        }

        function closeSnapshot() {
            document.getElementById('snapshot-preview').classList.add('hidden');
        }
    </script>
</body>
</html>
