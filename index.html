<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety Drive V3.1</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Giao diện Overlay */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        
        /* Trạng thái Ghi hình */
        .rec-box {
            background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; 
            border: 1px solid #dc3545; display: inline-flex; align-items: center;
        }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; margin-right: 8px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Màn hình Uploading */
        #upload-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        .top-bar { background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); padding: 15px; pointer-events: auto; color: white; }
        .bottom-controls { background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; pointer-events: auto; }
        .hidden { display: none !important; }

        #setup-screen {
            position: fixed; z-index: 9999; background: #fff; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        
        .btn-xl { height: 55px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="fw-bold text-primary mb-3">VDC CLOUD REC V3.1</h3>
        <input type="text" id="room-input" class="form-control form-control-lg mb-3 w-75 shadow-sm" placeholder="Nhập tên Trạm/Tổ...">
        <button class="btn btn-primary btn-lg w-100 mb-2 shadow" onclick="initApp('streamer')">ĐỘI HIỆN TRƯỜNG</button>
        <button class="btn btn-dark btn-lg w-100 shadow" onclick="initApp('viewer')">GIÁM SÁT (Lưu Drive)</button>
    </div>

    <div id="upload-overlay" class="hidden">
        <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h4>Đang gửi video lên Google Drive...</h4>
        <p class="text-white-50 small mt-2">Vui lòng KHÔNG tắt trình duyệt lúc này.</p>
        <div id="upload-status" class="fw-bold text-warning mt-2">Đang xử lý...</div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <div id="ui-layer">
            <div class="top-bar d-flex justify-content-between align-items-center">
                <div>
                    <div id="rec-display" class="rec-box hidden">
                        <div class="rec-dot"></div> <span class="fw-bold small text-white">REC</span>
                    </div>
                    <span id="room-lbl" class="ms-2 fw-bold small text-uppercase">...</span>
                </div>
                <button id="btn-rec-toggle" class="btn btn-sm btn-outline-danger hidden" onclick="toggleRecording()">
                    <i class="fas fa-circle"></i> Quay
                </button>
            </div>
            
            <div class="bottom-controls">
                <div id="viewer-btns" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger btn-xl w-100 shadow" onclick="confirmAction('danger')">CẢNH BÁO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-xl w-100 shadow" onclick="confirmAction('safe')">XÁC NHẬN & LƯU</button></div>
                </div>
                <div id="streamer-btns" class="hidden">
                    <button id="btn-work" class="btn btn-secondary btn-xl w-100 shadow" disabled>CHỜ DUYỆT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. LINK APP SCRIPT CỦA BẠN ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfbO0QC6-uklzUOMpuGKJkm_lU-RNuGVSO30zBZWFj6a3z3nWIydcLCNESO89q1Hq-HQ/exec";
        
        // CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        // === 2. KHỞI TẠO ===
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let peer, role = '', ROOM_ID = '';
        
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        function initApp(r) {
            const input = document.getElementById('room-input').value.trim();
            if(!input) return alert("Vui lòng nhập tên trạm!");
            
            // Tạo ID phòng chuẩn
            ROOM_ID = "VDC_" + input.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            role = r;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-lbl').innerText = input;

            listenSig();
            const config = { config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } };
            
            if (role === 'streamer') startStreamer(config);
            else {
                startViewer(config);
                document.getElementById('btn-rec-toggle').classList.remove('hidden');
            }
        }

        // === 3. LOGIC GHI HÌNH & UPLOAD DRIVE ===
        
        function toggleRecording() {
            if(!isRecording) startRecording();
            else stopRecordingAndUpload();
        }

        function startRecording() {
            const stream = document.getElementById('remote-video').srcObject;
            if(!stream) return alert("Chưa có tín hiệu video từ hiện trường!");

            recordedChunks = [];
            // Giới hạn bitrate 1.5Mbps để đảm bảo file nhẹ, upload nhanh qua Apps Script
            const options = { mimeType: 'video/webm; codecs=vp9', videoBitsPerSecond: 1500000 }; 
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm';

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch(e) { return alert("Thiết bị không hỗ trợ quay: " + e); }

            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
            
            // Khi dừng quay -> Tự động gọi hàm upload
            mediaRecorder.onstop = uploadToDrive; 

            mediaRecorder.start();
            isRecording = true;
            
            // Cập nhật giao diện
            document.getElementById('rec-display').classList.remove('hidden');
            document.getElementById('btn-rec-toggle').innerHTML = '<i class="fas fa-stop"></i> Dừng';
            document.getElementById('btn-rec-toggle').classList.replace('btn-outline-danger', 'btn-danger');
        }

        function stopRecordingAndUpload() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('rec-display').classList.add('hidden');
            }
        }

        function uploadToDrive() {
            // Hiện màn hình chờ upload
            document.getElementById('upload-overlay').classList.remove('hidden');
            document.getElementById('upload-status').innerText = "Đang nén video...";

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            // Chuyển video sang Base64 để gửi qua HTTP Post
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                // Tên file: VDC_TramX_GioPhutGiay.webm
                const fileName = `${ROOM_ID}_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`;

                document.getElementById('upload-status').innerText = "Đang đẩy lên Google Drive...";

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Bắt buộc 'no-cors' khi gọi Apps Script từ Client
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileData: base64data,
                        fileName: fileName,
                        mimeType: 'video/webm'
                    })
                })
                .then(() => {
                    // Do 'no-cors' nên luôn trả về opacity response, ta mặc định là thành công nếu không lỗi mạng
                    alert("✅ Đã lưu video vào thư mục 'livetream_video' trên Drive!");
                    document.getElementById('upload-overlay').classList.add('hidden');
                    
                    // Reset nút quay về trạng thái ban đầu
                    document.getElementById('btn-rec-toggle').innerHTML = '<i class="fas fa-circle"></i> Quay';
                    document.getElementById('btn-rec-toggle').classList.replace('btn-danger', 'btn-outline-danger');
                })
                .catch(error => {
                    alert("❌ Lỗi đường truyền: " + error);
                    document.getElementById('upload-overlay').classList.add('hidden');
                });
            }
        }

        // === 4. LOGIC XÁC NHẬN AN TOÀN ===
        function confirmAction(type) {
            db.ref('vdc_ops/' + ROOM_ID + '/status').set(type);
            
            // Nếu bấm XÁC NHẬN (An toàn) và đang quay -> Dừng quay và lưu ngay
            if(type === 'safe' && isRecording) {
                stopRecordingAndUpload();
            }
        }

        // === 5. KẾT NỐI WEBRTC (Ổn định xuyên tường lửa) ===
        async function startStreamer(config) {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-btns').classList.remove('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
                document.getElementById('local-video').srcObject = stream;
                peer = new Peer(config);
                peer.on('open', id => db.ref('vdc_ops/'+ROOM_ID).update({streamerID:id}));
                peer.on('call', call => call.answer(stream));
            } catch(e) { alert("Lỗi Camera: "+e); }
        }

        function startViewer(config) {
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-btns').classList.remove('hidden');
            peer = new Peer(config);
            peer.on('open', () => {
                db.ref('vdc_ops/'+ROOM_ID).on('value', snap => {
                    const d = snap.val();
                    if(d && d.streamerID) connect(d.streamerID);
                });
            });
        }

        let currCall;
        function connect(id) {
            if(currCall) return;
            // Dummy Stream trick để mở cổng kết nối P2P
            const canvas = document.createElement('canvas'); canvas.width=10; canvas.height=10;
            const dummy = canvas.captureStream(30); 
            const call = peer.call(id, dummy);
            currCall = call;
            call.on('stream', stream => {
                document.getElementById('remote-video').srcObject = stream;
            });
        }

        function listenSig() {
            const btn = document.getElementById('btn-work');
            db.ref('vdc_ops/'+ROOM_ID+'/status').on('value', snap => {
                const s = snap.val() || 'waiting';
                if(s === 'safe') {
                    btn.disabled = false; btn.innerText = "BẮT ĐẦU CÔNG VIỆC"; btn.className = "btn btn-primary btn-xl w-100 shadow";
                } else if(s === 'danger') {
                    btn.disabled = true; btn.innerText = "NGUY HIỂM!"; btn.className = "btn btn-secondary btn-xl w-100 shadow";
                    if(navigator.vibrate) navigator.vibrate(500);
                } else {
                    btn.disabled = true;
                }
            });
        }
    </script>
</body>
</html>
