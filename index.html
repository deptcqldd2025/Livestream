<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety V2.2</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        /* SETUP SCREEN */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        /* STREAMER UI (HI·ªÜN TR∆Ø·ªúNG) */
        #streamer-app { height: 100vh; background: #000; display: flex; flex-direction: column; }
        #video-preview { flex: 1; position: relative; }
        #local-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Log Panel */
        #log-panel { height: 150px; background: #111; overflow-y: scroll; padding: 10px; font-size: 11px; border-top: 1px solid #333; font-family: monospace; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-ok { color: #00ff00; } 
        .log-err { color: #ff4444; } 
        .log-wait { color: #ffc107; }

        /* VIEWER UI (GI√ÅM S√ÅT) */
        #viewer-app { padding: 20px; max-width: 600px; margin: 0 auto; min-height: 100vh; background: #f8f9fa; }
        .folder-card { 
            background: white; padding: 15px; margin-bottom: 12px; border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid #0d6efd;
            transition: transform 0.2s;
        }
        .folder-card:active { transform: scale(0.98); background: #e9ecef; }
        
        .hidden { display: none !important; }
        .btn-xl { height: 55px; font-weight: bold; width: 100%; font-size: 1.1rem; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="fw-bold text-primary mb-4">VDC SAFETY V2.2</h3>
        <p class="text-muted small">Update: New Backend Connection</p>
        
        <input type="text" id="room-input" class="form-control form-control-lg mb-3 w-100 shadow-sm" style="max-width: 350px;" placeholder="Nh·∫≠p t√™n Tr·∫°m...">
        
        <div class="d-grid gap-3 w-100" style="max-width: 350px;">
            <button class="btn btn-danger btn-lg shadow" onclick="initStreamer()">üé• ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG</button>
            <button class="btn btn-primary btn-lg shadow" onclick="initViewer()">üëÅÔ∏è GI√ÅM S√ÅT VI√äN</button>
        </div>
        <div class="mt-4 text-center">
            <small class="text-muted d-block">L∆∞u √Ω: M·ªü quy·ªÅn AppScript "Anyone" ƒë·ªÉ tr√°nh l·ªói.</small>
        </div>
    </div>

    <div id="streamer-app" class="hidden">
        <div id="video-preview">
            <video id="local-video" autoplay playsinline muted></video>
            
            <div style="position: absolute; top: 15px; left: 15px;">
                <span class="badge bg-danger shadow" id="rec-badge">STANDBY</span>
                <span class="badge bg-primary shadow ms-1" id="queue-badge">Queue: 0</span>
            </div>
            
            <div style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
                <button id="btn-start" class="btn btn-success btn-xl shadow" onclick="startRecording()">
                    <i class="fas fa-circle"></i> B·∫ÆT ƒê·∫¶U QUAY
                </button>
                <button id="btn-stop" class="btn btn-danger btn-xl shadow hidden" onclick="stopRecording()">
                    <i class="fas fa-stop"></i> D·ª™NG & L∆ØU
                </button>
            </div>
        </div>
        
        <div id="log-panel">
            <div class="log-line text-white">H·ªá th·ªëng s·∫µn s√†ng...</div>
        </div>
    </div>

    <div id="viewer-app" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0 text-primary"><i class="fas fa-folder-open"></i> GI√ÅM S√ÅT DRIVE</h4>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Tho√°t</button>
        </div>
        
        <p class="text-muted small">Danh s√°ch c√°c tr·∫°m ƒëang ho·∫°t ƒë·ªông (Click ƒë·ªÉ m·ªü Drive):</p>
        
        <div id="folder-list">
            <div class="text-center text-muted mt-5 py-5">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <div>ƒêang t·∫£i danh s√°ch tr·∫°m...</div>
            </div>
        </div>
        
        <div class="mt-5 text-center">
            <a href="https://drive.google.com/drive/u/0/folders/11GBcLqK2ggbntyRLt-ID23YLYzZWWON2" target="_blank" class="btn btn-outline-dark btn-sm">
                <i class="fab fa-google-drive"></i> M·ªü Drive T·ªïng
            </a>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH LI√äN K·∫æT ===
        // Link AppScript M·ªöI (V2.2) do b·∫°n cung c·∫•p:
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5ZRkSHK9qXg5-bz6bti71K8RLvBW5IOTg-lZX_Xy-YNF2Pd4wL5uFfqcnKAnc1kXWww/exec";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let ROOM_NAME = "", FOLDER_NAME = "";
        let mediaRecorder;
        let uploadQueue = [];
        let isUploading = false;
        let partIndex = 1;

        // === LOGIC CH·ªåN VAI TR√í ===
        function initStreamer() {
            const input = document.getElementById('room-input').value.trim();
            if(!input) return alert("Vui l√≤ng nh·∫≠p t√™n tr·∫°m!");
            
            ROOM_NAME = input;
            // T·∫°o t√™n folder chu·∫©n: VDC_TENTRAM_GIO_NGAY
            let d = new Date();
            let timeStr = `${d.getHours()}h${d.getMinutes()}_${d.getDate()}-${d.getMonth()+1}`;
            // Lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói t·∫°o folder
            let safeName = ROOM_NAME.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            FOLDER_NAME = `VDC_${safeName}_${timeStr}`;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('streamer-app').classList.remove('hidden');
            
            setupCamera();
            
            // ƒê·∫©y th√¥ng tin l√™n Firebase ƒë·ªÉ b√™n Gi√°m s√°t nh√¨n th·∫•y
            db.ref('vdc_folders/' + Date.now()).set({
                name: ROOM_NAME,
                folderName: FOLDER_NAME,
                timestamp: Date.now()
            });
            
            log(`Folder: ${FOLDER_NAME}`, 'wait');
        }

        function initViewer() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('viewer-app').classList.remove('hidden');
            loadFolderList();
        }

        // === LOGIC HI·ªÜN TR∆Ø·ªúNG (STREAMER) ===
        async function setupCamera() {
            try {
                // Quay 720p
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = stream;
                window.localStream = stream;
                log("Camera ƒë√£ s·∫µn s√†ng.", 'ok');
            } catch(e) { log("L·ªói Camera: " + e.message, 'err'); }
        }

        function startRecording() {
            partIndex = 1;
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
            document.getElementById('rec-badge').innerText = "REC";
            
            // VP8 l√† codec chu·∫©n cho web
            let options = { mimeType: 'video/webm;codecs=vp8' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };

            try {
                mediaRecorder = new MediaRecorder(window.localStream, options);
                
                mediaRecorder.ondataavailable = e => {
                    if(e.data.size > 0) {
                        uploadQueue.push({ blob: e.data, index: partIndex++ });
                        document.getElementById('queue-badge').innerText = "Queue: " + uploadQueue.length;
                        processQueue();
                    }
                };
                
                // C·∫Øt m·ªói 10 gi√¢y (10000ms) ƒë·ªÉ g·ª≠i cho nhanh
                mediaRecorder.start(10000); 
                log("ƒêang ghi h√¨nh... (10s/g√≥i)", 'ok');
            } catch(e) { log("L·ªói Recorder: " + e, 'err'); }
        }

        function processQueue() {
            if (isUploading || uploadQueue.length === 0) return;
            
            isUploading = true;
            const item = uploadQueue[0];
            const logId = `G√≥i ${item.index}`;
            log(`${logId}: ƒêang g·ª≠i...`, 'wait');

            const reader = new FileReader();
            reader.readAsDataURL(item.blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                const fileName = `Part_${String(item.index).padStart(3, '0')}.webm`;

                // Timeout 35s
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 35000);

                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // B·∫Øt bu·ªôc
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileData: base64data,
                        fileName: fileName,
                        mimeType: 'video/webm',
                        folderName: FOLDER_NAME
                    }),
                    signal: controller.signal
                })
                .then(() => {
                    clearTimeout(timeoutId);
                    log(`${logId}: -> OK (ƒê√£ l√™n Drive)`, 'ok');
                    
                    uploadQueue.shift(); // X√≥a kh·ªèi h√†ng ƒë·ª£i
                    isUploading = false;
                    document.getElementById('queue-badge').innerText = "Queue: " + uploadQueue.length;
                    
                    // G·ª≠i ti·∫øp c√°i sau ngay l·∫≠p t·ª©c
                    processQueue(); 
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    log(`${logId}: L·ªói m·∫°ng. Th·ª≠ l·∫°i sau 3s...`, 'err');
                    isUploading = false;
                    setTimeout(processQueue, 3000);
                });
            };
        }

        function stopRecording() {
            if(confirm("D·ª´ng quay v√† l∆∞u?")) {
                if(mediaRecorder) mediaRecorder.stop();
                document.getElementById('rec-badge').innerText = "STOPPED";
                document.getElementById('btn-start').classList.remove('hidden');
                document.getElementById('btn-stop').classList.add('hidden');
                log("ƒê√£ d·ª´ng quay. ƒêang g·ª≠i n·ªët video c√≤n l·∫°i...", 'wait');
            }
        }

        function log(msg, type) {
            const panel = document.getElementById('log-panel');
            const div = document.createElement('div');
            div.className = 'log-line ' + (type === 'ok' ? 'log-ok' : (type === 'err' ? 'log-err' : 'log-wait'));
            
            // Th√™m gi·ªù ph√∫t
            let t = new Date();
            let time = `${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`;
            div.innerText = `[${time}] ${msg}`;
            
            panel.insertBefore(div, panel.firstChild);
        }

        // === 3. LOGIC GI√ÅM S√ÅT (T·ª∞ ƒê·ªòNG T·∫¢I DANH S√ÅCH) ===
        function loadFolderList() {
            const list = document.getElementById('folder-list');
            
            // L·∫•y 15 tr·∫°m g·∫ßn nh·∫•t
            db.ref('vdc_folders').limitToLast(15).on('value', snap => {
                list.innerHTML = '';
                const data = snap.val();
                
                if (!data) {
                    list.innerHTML = '<div class="text-center text-muted py-5">Ch∆∞a c√≥ tr·∫°m n√†o ho·∫°t ƒë·ªông h√¥m nay.</div>';
                    return;
                }

                // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ tr·∫°m m·ªõi nh·∫•t l√™n ƒë·∫ßu
                const arr = Object.values(data).reverse();
                
                arr.forEach(item => {
                    // Link t√¨m ki·∫øm th√¥ng minh trong Drive
                    // T√¨m folder c√≥ t√™n ch√≠nh x√°c
                    const searchLink = `https://drive.google.com/drive/u/0/search?q=type:folder%20name:"${item.folderName}"`;
                    
                    const dateObj = new Date(item.timestamp);
                    const timeStr = dateObj.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                    
                    list.innerHTML += `
                        <div class="folder-card" onclick="window.open('${searchLink}', '_blank')">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="fw-bold text-primary m-0">${item.name}</h5>
                                <span class="badge bg-light text-dark border">${timeStr}</span>
                            </div>
                            <div class="small text-muted mt-2">
                                <i class="fas fa-folder"></i> ${item.folderName}
                            </div>
                            <div class="mt-2 text-end text-primary small">
                                B·∫•m ƒë·ªÉ m·ªü Drive <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
