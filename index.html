<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Check V1.2 (Fix Connect)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #222; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        /* Debug Logs */
        #debug-console {
            position: absolute; top: 60px; left: 10px; z-index: 20;
            background: rgba(0,0,0,0.7); color: #0f0; font-family: monospace;
            font-size: 10px; padding: 5px; max-width: 200px; pointer-events: none;
        }

        .top-bar {
            background: rgba(0,0,0,0.6); padding: 10px; color: white; display: flex; justify-content: space-between;
        }
        
        .status-center {
            pointer-events: auto; align-self: center; text-align: center;
            padding: 10px 20px; border-radius: 30px; 
            font-weight: bold; text-transform: uppercase; font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        .st-wait { background: #ffc107; color: #000; }
        .st-safe { background: #28a745; color: white; }
        .st-danger { background: #dc3545; color: white; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        .bottom-controls {
            background: rgba(0,0,0,0.8); padding: 20px; pointer-events: auto;
        }
        .btn-control { width: 100%; height: 50px; font-weight: bold; margin-bottom: 10px; border-radius: 8px; }

        #setup-screen {
            position: fixed; z-index: 9999; background: #fff; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="mb-4">CHỌN VAI TRÒ</h3>
        <button class="btn btn-primary btn-lg mb-3 w-75" onclick="initApp('streamer')">HIỆN TRƯỜNG (Camera)</button>
        <button class="btn btn-dark btn-lg w-75" onclick="initApp('viewer')">GIÁM SÁT (Xem)</button>
        <div class="mt-3 text-muted small">V1.2: Fix connection logic</div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <div id="debug-console">Logs:<br></div>

        <div id="ui-layer">
            <div class="top-bar">
                <span id="role-label">Role</span>
                <button class="btn btn-sm btn-outline-light" style="pointer-events:auto" onclick="location.reload()">Reset</button>
            </div>

            <div id="safety-badge" class="status-center st-wait">Đang kết nối...</div>

            <div class="bottom-controls">
                <div id="monitor-actions" class="hidden row">
                    <div class="col-6"><button class="btn btn-danger btn-control" onclick="sendSignal('danger')">CẢNH BÁO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-control" onclick="sendSignal('safe')">XÁC NHẬN</button></div>
                </div>
                <div id="field-actions" class="hidden">
                    <button id="btn-work" class="btn btn-secondary btn-control" disabled onclick="alert('Đã bắt đầu!')">BẮT ĐẦU LÀM VIỆC</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === CẤU HÌNH ===
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };
        const ROOM_ID = "VDC_LIVE_01"; 

        // === PEER CONFIG (QUAN TRỌNG: Thêm STUN Server Google) ===
        const peerConfig = {
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        // === INIT ===
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let peer;
        let myStream;
        let role = '';

        function log(msg) {
            const el = document.getElementById('debug-console');
            el.innerHTML += msg + "<br>";
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function initApp(selectedRole) {
            role = selectedRole;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('role-label').innerText = role === 'streamer' ? "HIỆN TRƯỜNG" : "GIÁM SÁT";

            // Listen Safety Logic (Liên thông nút bấm)
            listenSafety();

            if (role === 'streamer') {
                setupStreamer();
            } else {
                setupViewer();
            }
        }

        // === STREAMER LOGIC ===
        async function setupStreamer() {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('field-actions').classList.remove('hidden');
            
            try {
                log("1. Đang mở Camera...");
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = myStream;
                log("-> Camera OK");

                // Tạo Peer với ID ngẫu nhiên, sau đó đẩy lên Firebase
                peer = new Peer(peerConfig);

                peer.on('open', (id) => {
                    log("2. Peer ID: " + id);
                    // Ghi ID của streamer lên Firebase để Viewer biết đường gọi
                    db.ref('rooms/' + ROOM_ID).set({
                        streamerID: id,
                        active: true,
                        timestamp: Date.now()
                    });
                    log("-> Đã gửi ID lên Server");
                });

                peer.on('call', (call) => {
                    log("3. Có người gọi tới!");
                    call.answer(myStream);
                    log("-> Đang gửi video...");
                });

                peer.on('error', err => log("ERR: " + err.type));

            } catch (e) {
                log("LỖI CAM: " + e.message);
                alert("Không thể mở Camera. Kiểm tra quyền truy cập.");
            }
        }

        // === VIEWER LOGIC ===
        function setupViewer() {
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('monitor-actions').classList.remove('hidden');

            peer = new Peer(peerConfig);

            peer.on('open', (myId) => {
                log("1. Viewer Ready. Tìm Streamer...");
                
                // Lắng nghe Firebase để lấy ID của Streamer
                db.ref('rooms/' + ROOM_ID).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.streamerID) {
                        log("2. Thấy Streamer ID: " + data.streamerID);
                        connectToStreamer(data.streamerID);
                    } else {
                        log("Chưa thấy Streamer online...");
                    }
                });
            });

            peer.on('error', err => log("ERR: " + err.type));
        }

        let currentCall = null;
        function connectToStreamer(remoteId) {
            if (currentCall) return; // Đã gọi rồi thì thôi

            log("3. Đang gọi video tới Streamer...");
            // Gọi nhưng không cần gửi video của mình đi (tiết kiệm băng thông)
            const call = peer.call(remoteId, navigator.mediaDevices.getUserMedia ? null : null); 
            currentCall = call;

            call.on('stream', (remoteStream) => {
                log("4. Đã nhận được VIDEO!");
                const video = document.getElementById('remote-video');
                video.srcObject = remoteStream;
                
                // Hack để đảm bảo video chạy trên iPhone/Android
                video.onloadedmetadata = () => {
                    video.play().catch(e => log("Cần bấm vào màn hình để phát video"));
                };
            });

            call.on('close', () => {
                log("Kết nối bị đóng.");
                currentCall = null;
            });
        }

        // === SAFETY SIGNAL LOGIC (Firebase) ===
        function sendSignal(status) {
            db.ref('safety/' + ROOM_ID).set(status);
        }

        function listenSafety() {
            const badge = document.getElementById('safety-badge');
            const btnWork = document.getElementById('btn-work');

            db.ref('safety/' + ROOM_ID).on('value', (snap) => {
                const status = snap.val() || 'waiting';
                log("Status: " + status);

                if (status === 'waiting') {
                    badge.innerText = "CHỜ KIỂM TRA";
                    badge.className = "status-center st-wait";
                    btnWork.disabled = true; btnWork.classList.remove('btn-primary');
                } else if (status === 'safe') {
                    badge.innerText = "AN TOÀN OK";
                    badge.className = "status-center st-safe";
                    btnWork.disabled = false; btnWork.classList.add('btn-primary');
                } else {
                    badge.innerText = "NGUY HIỂM !!!";
                    badge.className = "status-center st-danger";
                    btnWork.disabled = true;
                    if(navigator.vibrate) navigator.vibrate(500);
                }
            });
        }
    </script>
</body>
</html>
