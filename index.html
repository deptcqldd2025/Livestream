<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety V4.0 (Full Control)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* VIDEO AREA */
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .paused-overlay { filter: grayscale(100%) blur(5px); }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Nút Bật Loa (Fix lỗi không nghe) */
        #audio-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; pointer-events: auto; text-align: center;
        }
        .pulse-btn { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Thanh trạng thái Upload */
        #upload-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px;
        }
        .progress { width: 100%; height: 25px; background: #333; border-radius: 15px; margin-top: 20px; }
        .progress-bar { background-color: #28a745; transition: width 0.3s; }

        /* Các thành phần UI khác */
        .top-bar { background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); padding: 15px; pointer-events: auto; color: white; }
        .bottom-controls { background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); padding: 20px; pointer-events: auto; }
        
        .rec-tag { background: red; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .hidden { display: none !important; }
        .btn-xl { height: 60px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; }

        #setup-screen {
            position: fixed; z-index: 9999; background: #fff; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="fw-bold text-primary mb-3">VDC SAFETY V4.0</h3>
        <p class="text-muted small">Kiểm soát luồng & Lưu tự động</p>
        <input type="text" id="room-input" class="form-control form-control-lg mb-3 w-75 shadow-sm" placeholder="Tên Trạm/Tổ...">
        <button class="btn btn-primary btn-lg w-100 mb-2 shadow" onclick="initApp('streamer')">ĐỘI HIỆN TRƯỜNG</button>
        <button class="btn btn-dark btn-lg w-100 shadow" onclick="initApp('viewer')">GIÁM SÁT VIÊN</button>
    </div>

    <div id="upload-screen" class="hidden">
        <h3 class="text-warning"><i class="fas fa-cloud-upload-alt"></i> ĐANG LƯU VIDEO...</h3>
        <p class="small text-white-50 mt-2">Đang gửi dữ liệu lên Google Drive.</p>
        <p class="small text-danger fw-bold">TUYỆT ĐỐI KHÔNG TẮT TRÌNH DUYỆT!</p>
        <h1 id="percent-txt" class="fw-bold my-3">0%</h1>
        <div class="progress w-75">
            <div id="prog-bar" class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
            
            <div id="audio-overlay" class="hidden">
                <button class="btn btn-danger rounded-circle shadow pulse-btn" style="width: 80px; height: 80px; border: 4px solid white;" onclick="forceAudio()">
                    <i class="fas fa-volume-up fa-2x"></i>
                </button>
                <div class="text-white fw-bold mt-3" style="text-shadow: 0 2px 4px black;">BẤM ĐỂ NGHE</div>
            </div>
        </div>

        <div id="ui-layer">
            <div class="top-bar d-flex justify-content-between align-items-center">
                <div>
                    <span id="rec-status" class="rec-tag hidden">REC</span>
                    <span id="room-lbl" class="fw-bold ms-2 text-uppercase">...</span>
                </div>
                <div id="connection-status" class="badge bg-warning text-dark">Chờ kết nối...</div>
            </div>
            
            <div class="bottom-controls">
                
                <div id="viewer-controls" class="hidden row g-2">
                    <div class="col-6">
                        <button class="btn btn-danger btn-xl w-100 shadow" onclick="sendSafety('danger')">
                            <i class="fas fa-times-circle"></i> CẢNH BÁO
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-success btn-xl w-100 shadow" onclick="sendSafety('safe')">
                            <i class="fas fa-check-circle"></i> XÁC NHẬN
                        </button>
                    </div>
                    <div class="col-12 mt-2 text-center text-white-50 small">
                        Video sẽ tự động lưu khi Hiện trường bấm "Kết thúc".
                    </div>
                </div>

                <div id="streamer-controls" class="hidden">
                    <div id="st-start-box">
                        <button class="btn btn-success btn-xl w-100 shadow" onclick="startStreaming()">
                            <i class="fas fa-broadcast-tower"></i> BẮT ĐẦU PHÁT HÌNH
                        </button>
                    </div>

                    <div id="st-live-box" class="hidden row g-2">
                        <div class="col-6">
                            <button id="btn-pause" class="btn btn-warning btn-xl w-100 shadow" onclick="togglePause()">
                                <i class="fas fa-pause"></i> TẠM DỪNG
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-danger btn-xl w-100 shadow" onclick="stopStreaming()">
                                <i class="fas fa-stop"></i> KẾT THÚC
                            </button>
                        </div>
                        <div class="col-12 mt-2">
                            <button id="btn-work" class="btn btn-secondary w-100 py-2" disabled>
                                Chờ xác nhận an toàn...
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // === LINK APPSCRIPT (GIỮ NGUYÊN) ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfbO0QC6-uklzUOMpuGKJkm_lU-RNuGVSO30zBZWFj6a3z3nWIydcLCNESO89q1Hq-HQ/exec";
        
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let peer; 
        let localStream;
        let role = '', ROOM_ID = '';
        
        // Biến ghi hình (chỉ Viewer dùng)
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        function initApp(r) {
            const input = document.getElementById('room-input').value.trim();
            if(!input) return alert("Vui lòng nhập tên Trạm!");
            
            ROOM_ID = "VDC_" + input.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            role = r;

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-lbl').innerText = input;

            if (role === 'streamer') {
                document.getElementById('streamer-controls').classList.remove('hidden');
                document.getElementById('local-video').classList.remove('hidden');
                // Reset trạng thái trên DB
                db.ref('vdc_ops/' + ROOM_ID).set({ state: 'idle', safety: 'waiting' });
                // Lắng nghe lệnh an toàn
                listenSafety();
            } else {
                document.getElementById('viewer-controls').classList.remove('hidden');
                document.getElementById('remote-video').classList.remove('hidden');
                initViewer();
            }
        }

        // ============================================
        // 1. LOGIC HIỆN TRƯỜNG (STREAMER)
        // ============================================

        async function startStreaming() {
            try {
                // Mở Camera
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = localStream;

                // Khởi tạo Peer
                peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
                
                peer.on('open', id => {
                    // Gửi ID và trạng thái 'live' lên DB
                    db.ref('vdc_ops/' + ROOM_ID).update({ streamerID: id, state: 'live' });
                    document.getElementById('connection-status').innerText = "Đang phát";
                    document.getElementById('connection-status').className = "badge bg-danger";
                });

                peer.on('call', call => {
                    // Trả lời cuộc gọi từ Viewer
                    call.answer(localStream);
                });

                // Chuyển giao diện
                document.getElementById('st-start-box').classList.add('hidden');
                document.getElementById('st-live-box').classList.remove('hidden');

            } catch (e) { alert("Lỗi Camera: " + e.message); }
        }

        function togglePause() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            const audioTrack = localStream.getAudioTracks()[0];
            
            if (videoTrack.enabled) {
                // Tắt hình/tiếng
                videoTrack.enabled = false;
                audioTrack.enabled = false;
                document.getElementById('btn-pause').innerHTML = '<i class="fas fa-play"></i> TIẾP TỤC';
                document.getElementById('btn-pause').classList.replace('btn-warning', 'btn-primary');
                db.ref('vdc_ops/' + ROOM_ID).update({ state: 'paused' });
            } else {
                // Bật lại
                videoTrack.enabled = true;
                audioTrack.enabled = true;
                document.getElementById('btn-pause').innerHTML = '<i class="fas fa-pause"></i> TẠM DỪNG';
                document.getElementById('btn-pause').classList.replace('btn-primary', 'btn-warning');
                db.ref('vdc_ops/' + ROOM_ID).update({ state: 'live' });
            }
        }

        function stopStreaming() {
            if (confirm("Kết thúc phiên làm việc? Video sẽ được lưu.")) {
                // Gửi lệnh kết thúc lên DB
                db.ref('vdc_ops/' + ROOM_ID).update({ state: 'ended' });
                
                // Tắt camera
                if (localStream) localStream.getTracks().forEach(track => track.stop());
                
                // Reset giao diện
                location.reload();
            }
        }

        function listenSafety() {
            db.ref('vdc_ops/' + ROOM_ID + '/safety').on('value', snap => {
                const s = snap.val();
                const btn = document.getElementById('btn-work');
                if (s === 'safe') {
                    btn.className = "btn btn-primary w-100 py-2 fw-bold";
                    btn.innerText = "ĐÃ DUYỆT - BẮT ĐẦU LÀM VIỆC";
                } else if (s === 'danger') {
                    btn.className = "btn btn-danger w-100 py-2 fw-bold";
                    btn.innerText = "NGUY HIỂM - DỪNG LẠI";
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                }
            });
        }

        // ============================================
        // 2. LOGIC GIÁM SÁT (VIEWER & RECORDER)
        // ============================================

        function initViewer() {
            peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
            
            peer.on('open', () => {
                // Lắng nghe thay đổi trạng thái từ Streamer
                db.ref('vdc_ops/' + ROOM_ID).on('value', snap => {
                    const data = snap.val();
                    if (!data) return;

                    // 1. Nếu Streamer online và đang 'live' -> Kết nối
                    if (data.streamerID && (data.state === 'live' || data.state === 'paused')) {
                        connectToStreamer(data.streamerID);
                        
                        if (data.state === 'paused') {
                            document.getElementById('connection-status').innerText = "Đang tạm dừng";
                            document.getElementById('remote-video').classList.add('paused-overlay');
                        } else {
                            document.getElementById('connection-status').innerText = "Trực tiếp";
                            document.getElementById('connection-status').className = "badge bg-success";
                            document.getElementById('remote-video').classList.remove('paused-overlay');
                        }
                    } 
                    
                    // 2. Nếu Streamer bấm 'KẾT THÚC' -> Dừng quay và Upload
                    if (data.state === 'ended' && isRecording) {
                        finishAndUpload();
                    }
                });
            });
        }

        let currentConn;
        function connectToStreamer(id) {
            if (currentConn) return; // Đã kết nối thì thôi
            
            // Dummy stream để bắt tay
            const canvas = document.createElement('canvas'); 
            const dummy = canvas.captureStream(10);
            const call = peer.call(id, dummy);
            currentConn = call;

            call.on('stream', stream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = stream;
                
                // Hiện nút Bật Loa
                document.getElementById('audio-overlay').classList.remove('hidden');
                
                // Tự động BẮT ĐẦU GHI HÌNH ngay khi có tín hiệu
                startRecording(stream);
            });
        }

        // Hàm bật loa mạnh mẽ (Hard Unmute)
        function forceAudio() {
            const vid = document.getElementById('remote-video');
            vid.muted = false;
            vid.volume = 1.0;
            vid.play().then(() => {
                document.getElementById('audio-overlay').classList.add('hidden');
                // Thử kích hoạt lại audio context nếu cần
            }).catch(e => alert("Lỗi Audio: " + e));
        }

        // --- GHI HÌNH & UPLOAD ---

        function startRecording(stream) {
            if (isRecording) return;
            
            recordedChunks = [];
            // Chọn codec phổ biến
            const options = { mimeType: 'video/webm; codecs=vp8', videoBitsPerSecond: 1000000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm';

            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            
            mediaRecorder.start(1000); // Lưu chunk mỗi 1s
            isRecording = true;
            document.getElementById('rec-status').classList.remove('hidden');
        }

        function finishAndUpload() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
            
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('rec-status').classList.add('hidden');
            
            // Hiện màn hình Upload
            document.getElementById('upload-screen').classList.remove('hidden');
            
            // Đợi 1 chút để chunk cuối cùng được đẩy vào
            setTimeout(() => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                uploadFile(blob);
            }, 500);
        }

        function uploadFile(blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                const fileName = `${ROOM_ID}_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`;

                var xhr = new XMLHttpRequest();
                xhr.open("POST", APPS_SCRIPT_URL, true);
                // Dùng text/plain để tránh CORS preflight phức tạp
                xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8'); 

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('percent-txt').innerText = percent + "%";
                        document.getElementById('prog-bar').style.width = percent + "%";
                    }
                };

                xhr.onload = function() {
                    alert("✅ Video đã được lưu an toàn vào Google Drive!");
                    location.reload();
                };

                xhr.onerror = function() {
                    alert("❌ Lỗi mạng. Vui lòng kiểm tra lại.");
                    document.getElementById('upload-screen').classList.add('hidden');
                };

                xhr.send(JSON.stringify({
                    fileData: base64data,
                    fileName: fileName,
                    mimeType: 'video/webm'
                }));
            };
        }

        // Gửi lệnh an toàn
        function sendSafety(status) {
            db.ref('vdc_ops/' + ROOM_ID).update({ safety: status });
        }

    </script>
</body>
</html>
