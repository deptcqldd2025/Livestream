<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety V6.0 (Dashboard)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* === M√ÄN H√åNH DASHBOARD GI√ÅM S√ÅT === */
        #dashboard-screen { background: #f8f9fa; height: 100%; overflow-y: auto; padding-bottom: 50px; }
        .nav-pills .nav-link.active { background-color: #dc3545; }
        .live-card { border-left: 5px solid #28a745; cursor: pointer; transition: transform 0.2s; }
        .live-card:active { transform: scale(0.98); }
        .offline-card { border-left: 5px solid #6c757d; }
        
        /* === M√ÄN H√åNH LIVESTREAM === */
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* N√∫t B·∫≠t Loa (Fix l·ªói √¢m thanh) */
        #audio-btn-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; pointer-events: auto;
        }

        /* Upload Screen */
        #upload-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px;
        }
        .progress { width: 100%; height: 25px; background: #333; margin-top: 20px; border-radius: 15px; }
        .progress-bar { background-color: #0d6efd; transition: width 0.3s; }

        .hidden { display: none !important; }
        .btn-xl { height: 55px; font-weight: bold; font-size: 1.1rem; border-radius: 10px; }
        
        #setup-screen { position: fixed; z-index: 9999; background: #fff; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="fw-bold text-primary mb-4">VDC SAFETY V6.0</h3>
        <div class="d-grid gap-3 col-10">
            <button class="btn btn-primary btn-lg py-3 shadow" onclick="showStreamerInput()">
                <i class="fas fa-video"></i> ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG
            </button>
            <button class="btn btn-dark btn-lg py-3 shadow" onclick="initDashboard()">
                <i class="fas fa-columns"></i> GI√ÅM S√ÅT (Dashboard)
            </button>
        </div>
        
        <div id="streamer-input-box" class="hidden mt-4 w-75">
            <input type="text" id="room-input" class="form-control form-control-lg mb-2" placeholder="Nh·∫≠p t√™n Tr·∫°m/T·ªï...">
            <button class="btn btn-success w-100" onclick="initStreamer()">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn btn-link text-muted w-100 mt-2" onclick="location.reload()">Quay l·∫°i</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div class="bg-white shadow-sm p-3 sticky-top">
            <h5 class="fw-bold text-danger m-0"><i class="fas fa-shield-alt"></i> TRUNG T√ÇM GI√ÅM S√ÅT</h5>
        </div>
        
        <ul class="nav nav-pills nav-fill m-3 bg-white rounded shadow-sm p-1" id="pills-tab">
            <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#tab-live">üî¥ ONLINE (<span id="count-live">0</span>)</button></li>
            <li class="nav-item"><button class="nav-link fw-bold text-secondary" data-bs-toggle="pill" data-bs-target="#tab-history">üìÅ L·ªäCH S·ª¨</button></li>
        </ul>

        <div class="tab-content p-3">
            <div class="tab-pane fade show active" id="tab-live">
                <div id="list-live" class="d-grid gap-3">
                    <div class="text-center text-muted mt-5">Ch∆∞a c√≥ tr·∫°m n√†o online...</div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-history">
                <div id="list-history" class="d-grid gap-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
            
            <div id="audio-btn-overlay" class="hidden">
                <button class="btn btn-light rounded-circle shadow border border-danger" style="width: 80px; height: 80px;" onclick="enableAudioForce()">
                    <i class="fas fa-volume-up fa-2x text-danger"></i>
                </button>
                <div class="text-white fw-bold mt-2" style="text-shadow: 1px 1px 2px black;">B·∫¨T TI·∫æNG</div>
            </div>
        </div>

        <div id="ui-layer">
            <div class="d-flex justify-content-between p-3" style="background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);">
                <div>
                    <span id="rec-tag" class="badge bg-danger hidden">REC</span>
                    <span id="room-lbl" class="text-white fw-bold ms-2">...</span>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload()">Tho√°t</button>
            </div>
            
            <div class="p-3" style="background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                <div id="viewer-controls" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger btn-xl w-100 shadow" onclick="sendSignal('danger')">C·∫¢NH B√ÅO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-xl w-100 shadow" onclick="sendSignal('safe')">X√ÅC NH·∫¨N</button></div>
                </div>
                
                <div id="streamer-controls" class="hidden">
                    <button class="btn btn-danger btn-xl w-100 shadow" onclick="finishSession()">
                        <i class="fas fa-stop-circle"></i> K·∫æT TH√öC & L∆ØU
                    </button>
                    <button id="btn-status" class="btn btn-secondary w-100 mt-2" disabled>ƒêang ch·ªù duy·ªát...</button>
                </div>
            </div>
        </div>
    </div>

    <div id="upload-screen" class="hidden">
        <div id="upload-content" class="text-center w-100">
            <h3 class="text-warning fw-bold">ƒêANG X·ª¨ L√ù VIDEO...</h3>
            <p class="text-white-50">ƒêang th·ª≠ g·ª≠i l√™n Google Drive.</p>
            <div class="progress w-75 mx-auto"><div id="prog-bar" class="progress-bar" style="width: 0%"></div></div>
            <div id="percent-txt" class="text-white mt-2">0%</div>
        </div>
        <div id="rescue-box" class="hidden text-center border border-danger p-3 rounded bg-dark mt-3">
            <h4 class="text-danger">M·∫†NG Y·∫æU - KH√îNG G·ª¨I ƒê∆Ø·ª¢C!</h4>
            <p class="text-white small">Video v·∫´n an to√†n. H√£y t·∫£i v·ªÅ m√°y ngay.</p>
            <button class="btn btn-success w-100 py-3 shadow" onclick="downloadLocally()">
                <i class="fas fa-download"></i> L∆ØU V·ªÄ M√ÅY ƒêI·ªÜN THO·∫†I
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CONFIG
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfbO0QC6-uklzUOMpuGKJkm_lU-RNuGVSO30zBZWFj6a3z3nWIydcLCNESO89q1Hq-HQ/exec";
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let peer, ROOM_ID = '', role = '';
        let mediaRecorder, recordedChunks = [], isRecording = false;

        // === 1. LOGIC SETUP ===
        function showStreamerInput() {
            document.querySelector('.d-grid').classList.add('hidden');
            document.getElementById('streamer-input-box').classList.remove('hidden');
        }

        // === 2. LOGIC DASHBOARD GI√ÅM S√ÅT ===
        function initDashboard() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            
            // L·∫Øng nghe d·ªØ li·ªáu realtime
            db.ref('vdc_ops').on('value', snap => {
                const listLive = document.getElementById('list-live');
                const listHistory = document.getElementById('list-history');
                listLive.innerHTML = ''; listHistory.innerHTML = '';
                let liveCount = 0;

                snap.forEach(child => {
                    const data = child.val();
                    const key = child.key;
                    const name = key.replace('VDC_', '').replace(/_/g, ' ');
                    
                    if (data.status === 'live') {
                        liveCount++;
                        listLive.innerHTML += `
                            <div class="card live-card shadow-sm p-3" onclick="joinRoom('${key}', '${name}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="fw-bold m-0">${name}</h5>
                                    <span class="badge bg-danger">LIVE</span>
                                </div>
                                <small class="text-muted">ƒêang ho·∫°t ƒë·ªông...</small>
                            </div>
                        `;
                    } else if (data.status === 'ended') {
                        let linkHTML = `<span class="text-muted small">Ch·ªâ l∆∞u tr√™n m√°y tr·∫°m</span>`;
                        if(data.driveLink) {
                            linkHTML = `<a href="${data.driveLink}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Xem Video Drive</a>`;
                        }
                        
                        listHistory.innerHTML += `
                            <div class="card offline-card shadow-sm p-3">
                                <div class="d-flex justify-content-between">
                                    <h6 class="fw-bold">${name}</h6>
                                    <span class="badge bg-secondary">K·∫øt th√∫c</span>
                                </div>
                                <small class="text-muted">Th·ªùi gian: ${new Date(data.timestamp || Date.now()).toLocaleTimeString()}</small>
                                ${linkHTML}
                            </div>
                        `;
                    }
                });
                document.getElementById('count-live').innerText = liveCount;
            });
        }

        function joinRoom(id, name) {
            ROOM_ID = id;
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-lbl').innerText = name;
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-controls').classList.remove('hidden');
            
            initPeerViewer(); // K·∫øt n·ªëi video
        }

        // === 3. LOGIC HI·ªÜN TR∆Ø·ªúNG (STREAMER) ===
        async function initStreamer() {
            const input = document.getElementById('room-input').value.trim();
            if(!input) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            ROOM_ID = "VDC_" + input.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-lbl').innerText = input;
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-controls').classList.remove('hidden');

            try {
                // Audio ph·∫£i l√† TRUE ·ªü ƒë√¢y ƒë·ªÉ g·ª≠i ƒëi, nh∆∞ng local-video ph·∫£i MUTED trong HTML
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 640}, height: {ideal: 480} }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = stream;
                
                // Ghi h√¨nh n·ªôi b·ªô
                startRecording(stream);

                // Ph√°t Peer
                peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
                peer.on('open', id => {
                    db.ref('vdc_ops/' + ROOM_ID).set({ 
                        streamerID: id, 
                        status: 'live',
                        timestamp: Date.now(),
                        driveLink: ''
                    });
                });
                peer.on('call', call => call.answer(stream));

                listenSignal(); // Nghe l·ªánh t·ª´ Gi√°m s√°t
            } catch(e) { alert("L·ªói Cam: " + e.message); }
        }

        function startRecording(stream) {
            recordedChunks = [];
            let options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 250000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' }; 

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch(e) { return; }

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => tryUpload(3);
            mediaRecorder.start(1000);
            document.getElementById('rec-tag').classList.remove('hidden');
        }

        function finishSession() {
            if(confirm("K·∫øt th√∫c v√† l∆∞u video?")) {
                if(mediaRecorder) mediaRecorder.stop();
                db.ref('vdc_ops/' + ROOM_ID).update({ status: 'ended' });
                document.getElementById('streamer-controls').classList.add('hidden');
            }
        }

        // === 4. LOGIC UPLOAD & C·ª®U H·ªò ===
        function tryUpload(retries) {
            document.getElementById('upload-screen').classList.remove('hidden');
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            if (blob.size > 45 * 1024 * 1024) { // > 45MB th√¨ kh√¥ng g·ª≠i
                showRescue(); return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                const fileName = `${ROOM_ID}_${Date.now()}.webm`;

                var xhr = new XMLHttpRequest();
                xhr.open("POST", APPS_SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
                xhr.timeout = 60000;

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var p = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('prog-bar').style.width = p + "%";
                        document.getElementById('percent-txt').innerText = p + "%";
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const res = JSON.parse(xhr.responseText);
                            if(res.result === 'success') {
                                // G·ª≠i Link Drive l√™n Firebase ƒë·ªÉ Gi√°m s√°t th·∫•y
                                db.ref('vdc_ops/' + ROOM_ID).update({ driveLink: res.fileUrl });
                                alert("‚úÖ Upload th√†nh c√¥ng!");
                                location.reload();
                            } else throw new Error();
                        } catch(e) { handleError(retries); }
                    } else handleError(retries);
                };
                xhr.onerror = () => handleError(retries);
                xhr.ontimeout = () => handleError(retries);
                xhr.send(JSON.stringify({ fileData: base64data, fileName: fileName, mimeType: 'video/webm' }));
            }
        }

        function handleError(retries) {
            if(retries > 1) setTimeout(() => tryUpload(retries - 1), 2000);
            else showRescue();
        }

        function showRescue() {
            document.getElementById('upload-content').classList.add('hidden');
            document.getElementById('rescue-box').classList.remove('hidden');
        }

        function downloadLocally() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${ROOM_ID}_BACKUP.webm`;
            document.body.appendChild(a); a.click();
            setTimeout(() => { location.reload(); }, 2000);
        }

        // === 5. LOGIC VIEWER (AUDIO FIX) ===
        function initPeerViewer() {
            peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
            peer.on('open', () => {
                db.ref('vdc_ops/' + ROOM_ID).once('value', snap => {
                    const d = snap.val();
                    if (d && d.streamerID) connectToStreamer(d.streamerID);
                });
            });
        }

        function connectToStreamer(id) {
            const canvas = document.createElement('canvas'); const dummy = canvas.captureStream(10);
            const call = peer.call(id, dummy);
            call.on('stream', stream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = stream;
                // Hi·ªán n√∫t b·∫≠t loa ngay khi c√≥ k·∫øt n·ªëi
                document.getElementById('audio-btn-overlay').classList.remove('hidden');
            });
        }

        // H√†m c∆∞·ª°ng ch·∫ø b·∫≠t √¢m thanh
        function enableAudioForce() {
            const vid = document.getElementById('remote-video');
            vid.muted = false; // B·ªè mute
            vid.volume = 1.0;  // Max volume
            vid.play().then(() => {
                document.getElementById('audio-btn-overlay').classList.add('hidden');
            }).catch(e => {
                alert("Kh√¥ng th·ªÉ b·∫≠t ti·∫øng: " + e);
            });
        }

        // Signal Logic
        function sendSignal(type) { db.ref('vdc_ops/' + ROOM_ID).update({ signal: type }); }
        function listenSignal() {
            db.ref('vdc_ops/' + ROOM_ID + '/signal').on('value', snap => {
                const s = snap.val();
                const btn = document.getElementById('btn-status');
                if(s === 'safe') {
                    btn.className = "btn btn-primary w-100 mt-2 fw-bold"; btn.innerText = "ƒê√É DUY·ªÜT AN TO√ÄN";
                } else if(s === 'danger') {
                    btn.className = "btn btn-danger w-100 mt-2 fw-bold"; btn.innerText = "C·∫¢NH B√ÅO NGUY HI·ªÇM";
                    if(navigator.vibrate) navigator.vibrate(500);
                }
            });
        }
    </script>
</body>
</html>
