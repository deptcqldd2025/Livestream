<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety V8.0 (Stable)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #f4f6f8; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* === SETUP & DASHBOARD === */
        #setup-screen, #dashboard-screen { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: #fff; z-index: 2000; overflow-y: auto;
        }
        .live-card { border-left: 5px solid #28a745; cursor: pointer; transition: 0.2s; }
        .live-card:active { transform: scale(0.98); background: #e9ecef; }
        .offline-card { border-left: 5px solid #6c757d; opacity: 0.7; }

        /* === MAIN APP === */
        #main-app { position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1000; }
        
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Lớp giao diện tương tác */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; pointer-events: none; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .interactive { pointer-events: auto !important; }

        /* Nút bật/tắt tiếng thủ công (Fix lỗi Audio) */
        #volume-toggle {
            position: absolute; bottom: 180px; right: 20px; z-index: 150;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.6); color: white; border: 2px solid white;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .muted-state { background: rgba(220, 53, 69, 0.8) !important; animation: pulse 2s infinite; }

        /* Upload Screen */
        #upload-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        .btn-xl { height: 60px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; }
        .hidden { display: none !important; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; animation: blink 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="setup-screen" class="d-flex flex-column justify-content-center align-items-center p-4">
        <h2 class="fw-bold text-primary mb-4">VDC SAFETY V8.0</h2>
        <div class="d-grid gap-3 w-100" style="max-width: 400px;">
            <button class="btn btn-primary btn-lg shadow py-3" onclick="showStreamerInput()">
                <i class="fas fa-video"></i> ĐỘI HIỆN TRƯỜNG
            </button>
            <button class="btn btn-dark btn-lg shadow py-3" onclick="openDashboard()">
                <i class="fas fa-columns"></i> GIÁM SÁT VIÊN
            </button>
        </div>

        <div id="streamer-input" class="hidden w-100 mt-4" style="max-width: 400px;">
            <label class="fw-bold">Nhập tên Trạm:</label>
            <input type="text" id="room-name" class="form-control form-control-lg mb-3" placeholder="Ví dụ: Tram Bien Hoa">
            <button class="btn btn-success w-100 btn-lg" onclick="startStreamerSession()">BẮT ĐẦU PHÁT</button>
            <button class="btn btn-link w-100 mt-2" onclick="location.reload()">Quay lại</button>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div class="sticky-top bg-white shadow-sm p-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold text-danger">TRUNG TÂM GIÁM SÁT</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">Thoát</button>
        </div>
        <div class="container py-3">
            <h6 class="text-muted fw-bold mb-3"><i class="fas fa-satellite-dish"></i> ĐANG TRỰC TUYẾN</h6>
            <div id="live-list" class="d-grid gap-3">
                <div class="text-center py-5 text-muted">Đang quét tín hiệu...</div>
            </div>
            
            <h6 class="text-muted fw-bold mt-5 mb-3"><i class="fas fa-history"></i> ĐÃ KẾT THÚC</h6>
            <div id="history-list" class="d-grid gap-3 opacity-75"></div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-container">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <button id="volume-toggle" class="interactive hidden muted-state shadow" onclick="toggleAudio()">
            <i class="fas fa-volume-mute" id="vol-icon"></i>
        </button>

        <div id="ui-layer">
            <div class="p-3 interactive d-flex justify-content-between align-items-start" style="background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);">
                <div>
                    <span id="rec-badge" class="badge bg-danger hidden"><span class="rec-dot"></span> REC</span>
                    <span id="room-badge" class="badge bg-dark ms-1">...</span>
                </div>
                <button class="btn btn-sm btn-light interactive" onclick="location.reload()">Thoát</button>
            </div>

            <div class="p-3 interactive" style="background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                <div id="viewer-btns" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger btn-xl w-100 shadow interactive" onclick="sendCmd('danger')">CẢNH BÁO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-xl w-100 shadow interactive" onclick="sendCmd('safe')">XÁC NHẬN</button></div>
                    <div class="col-12 text-center text-white-50 small mt-1">Bấm nút loa bên phải để nghe tiếng.</div>
                </div>

                <div id="streamer-btns" class="hidden">
                    <button class="btn btn-danger btn-xl w-100 shadow interactive mb-2" onclick="stopStreamerSession()">
                        <i class="fas fa-stop"></i> KẾT THÚC & LƯU
                    </button>
                    <button id="status-btn" class="btn btn-secondary w-100 interactive" disabled>Đang chờ...</button>
                </div>
            </div>
        </div>
    </div>

    <div id="upload-screen" class="hidden">
        <h3 class="fw-bold text-warning">ĐANG LƯU VIDEO...</h3>
        <p>Vui lòng chờ. Không tắt trình duyệt.</p>
        <div class="progress w-75 my-3" style="height: 20px;">
            <div id="prog-bar" class="progress-bar bg-success" style="width: 0%"></div>
        </div>
        <div id="prog-text">0%</div>
        <div id="rescue-btn" class="hidden mt-4 text-center">
            <p class="text-danger small">Lỗi mạng! Hãy lưu về máy.</p>
            <button class="btn btn-light interactive shadow" onclick="saveLocally()">LƯU VỀ MÁY</button>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfbO0QC6-uklzUOMpuGKJkm_lU-RNuGVSO30zBZWFj6a3z3nWIydcLCNESO89q1Hq-HQ/exec";
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let peer, ROOM_ID = '', role = '';
        let mediaRecorder, recordedChunks = [];

        // === NAVIGATION ===
        function showStreamerInput() {
            document.querySelector('#setup-screen .d-grid').classList.add('hidden');
            document.getElementById('streamer-input').classList.remove('hidden');
        }

        function openDashboard() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            listenDashboard();
        }

        // === DASHBOARD LOGIC (Fix lỗi Online ảo) ===
        function listenDashboard() {
            db.ref('vdc_ops').on('value', snap => {
                const liveList = document.getElementById('live-list');
                const histList = document.getElementById('history-list');
                liveList.innerHTML = ''; histList.innerHTML = '';
                let hasLive = false;

                snap.forEach(child => {
                    const d = child.val();
                    const rid = child.key;
                    const name = rid.replace('VDC_', '').replace(/_/g, ' ');
                    
                    // Chỉ hiện Online nếu status = 'live'
                    if (d.status === 'live') {
                        hasLive = true;
                        liveList.innerHTML += `
                            <div class="card live-card p-3 shadow-sm mb-2" onclick="joinRoom('${rid}', '${name}', '${d.streamerID}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="fw-bold m-0">${name}</h5>
                                    <span class="badge bg-danger blink">LIVE</span>
                                </div>
                                <small class="text-success"><i class="fas fa-check-circle"></i> Đang phát</small>
                            </div>`;
                    } else if (d.status === 'ended' || d.status === 'offline') {
                        let link = d.driveLink ? `<a href="${d.driveLink}" target="_blank" class="text-primary mt-1 d-block small">Xem trên Drive</a>` : '<span class="text-muted small">Lưu cục bộ</span>';
                        histList.innerHTML += `
                            <div class="card offline-card p-2 mb-2 bg-light">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold">${name}</span>
                                    <span class="badge bg-secondary">Offline</span>
                                </div>
                                ${link}
                            </div>`;
                    }
                });
                
                if(!hasLive) liveList.innerHTML = '<div class="text-center text-muted p-4">Không có trạm nào online.</div>';
            });
        }

        // === VIEWER LOGIC ===
        function joinRoom(rid, rname, streamerID) {
            ROOM_ID = rid;
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-badge').innerText = rname;
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-btns').classList.remove('hidden');
            document.getElementById('volume-toggle').classList.remove('hidden');

            initViewer(streamerID);
        }

        function initViewer(targetID) {
            peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
            peer.on('open', () => {
                connectTo(targetID);
            });
        }

        function connectTo(id) {
            const canvas = document.createElement('canvas'); const dummy = canvas.captureStream(10);
            const call = peer.call(id, dummy);
            
            call.on('stream', stream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = stream;
                // Mặc định Muted để auto-play chạy được
                vid.muted = true;
                vid.play();
            });
        }

        // Fix lỗi âm thanh: Nút bấm thủ công
        function toggleAudio() {
            const vid = document.getElementById('remote-video');
            const btn = document.getElementById('volume-toggle');
            const icon = document.getElementById('vol-icon');
            
            if (vid.muted) {
                vid.muted = false;
                vid.volume = 1.0;
                // Thử play lại để chắc chắn
                vid.play().then(() => {
                    btn.classList.remove('muted-state');
                    icon.className = 'fas fa-volume-up';
                }).catch(e => alert("Trình duyệt chặn tiếng. Hãy chạm vào màn hình 1 cái rồi bấm lại!"));
            } else {
                vid.muted = true;
                btn.classList.add('muted-state');
                icon.className = 'fas fa-volume-mute';
            }
        }

        function sendCmd(type) { db.ref('vdc_ops/' + ROOM_ID).update({ signal: type }); }

        // === STREAMER LOGIC ===
        async function startStreamerSession() {
            const name = document.getElementById('room-name').value.trim();
            if(!name) return alert("Nhập tên trạm!");
            ROOM_ID = "VDC_" + name.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('streamer-btns').classList.remove('hidden');
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('room-badge').innerText = name;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = stream;
                startRecording(stream);

                peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
                
                peer.on('open', id => {
                    // Cập nhật trạng thái 'live'
                    const roomRef = db.ref('vdc_ops/' + ROOM_ID);
                    roomRef.set({
                        streamerID: id,
                        status: 'live',
                        signal: 'waiting',
                        timestamp: Date.now()
                    });

                    // QUAN TRỌNG: Tự động chuyển về Offline khi mất kết nối (Đóng tab, rớt mạng)
                    roomRef.onDisconnect().update({ status: 'offline' });
                });

                peer.on('call', call => call.answer(stream));

                db.ref('vdc_ops/' + ROOM_ID + '/signal').on('value', snap => {
                    const s = snap.val();
                    const btn = document.getElementById('status-btn');
                    if(s === 'safe') { btn.className = "btn btn-primary w-100 interactive fw-bold"; btn.innerText = "ĐÃ DUYỆT AN TOÀN"; } 
                    else if(s === 'danger') { btn.className = "btn btn-danger w-100 interactive fw-bold"; btn.innerText = "CẢNH BÁO NGUY HIỂM!"; navigator.vibrate([500,200,500]); }
                });

            } catch(e) { alert("Lỗi Cam: " + e.message); }
        }

        function startRecording(stream) {
            recordedChunks = [];
            let options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 250000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };

            try {
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = uploadVideo;
                mediaRecorder.start(1000);
                document.getElementById('rec-badge').classList.remove('hidden');
            } catch(e) { console.error(e); }
        }

        function stopStreamerSession() {
            if(confirm("Kết thúc công việc?")) {
                if(mediaRecorder) mediaRecorder.stop();
                db.ref('vdc_ops/' + ROOM_ID).update({ status: 'ended' }); // Cập nhật ended khi bấm nút
            }
        }

        // === UPLOAD ===
        function uploadVideo() {
            document.getElementById('upload-screen').classList.remove('hidden');
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            if(blob.size > 45 * 1024 * 1024) { failUpload(); return; }

            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                const fileName = `${ROOM_ID}_${Date.now()}.webm`;

                const xhr = new XMLHttpRequest();
                xhr.open("POST", APPS_SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
                xhr.timeout = 120000;

                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) {
                        const p = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('prog-bar').style.width = p + "%";
                        document.getElementById('prog-text').innerText = p + "%";
                    }
                };

                xhr.onload = () => {
                    if(xhr.status === 200) {
                        const res = JSON.parse(xhr.responseText);
                        if(res.result === 'success') {
                            db.ref('vdc_ops/' + ROOM_ID).update({ driveLink: res.fileUrl });
                            alert("✅ Thành công!"); location.reload();
                        } else failUpload();
                    } else failUpload();
                };
                xhr.onerror = failUpload; xhr.ontimeout = failUpload;
                xhr.send(JSON.stringify({ fileData: base64data, fileName: fileName, mimeType: 'video/webm' }));
            };
        }

        function failUpload() {
            document.getElementById('prog-text').innerText = "Thất bại.";
            document.getElementById('rescue-btn').classList.remove('hidden');
        }

        function saveLocally() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${ROOM_ID}_Backup.webm`;
            document.body.appendChild(a); a.click();
        }
    </script>
</body>
</html>
