<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safety Live V1.6 (Dummy Fix)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        #video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* DEBUG LOGS */
        #console-log {
            position: absolute; top: 70px; left: 10px; width: 280px; max-height: 200px;
            overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0;
            font-size: 11px; font-family: monospace; padding: 10px; z-index: 100;
            border-left: 3px solid #0f0; pointer-events: none;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .top-bar { padding: 10px; background: rgba(0,0,0,0.5); pointer-events: auto; color: white; display: flex; justify-content: space-between; }
        .bottom-controls { background: rgba(0,0,0,0.8); padding: 15px; pointer-events: auto; }
        .hidden { display: none !important; }
        
        .status-badge { 
            padding: 8px 20px; border-radius: 20px; font-weight: bold; 
            background: #fff; color: #000; align-self: center; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #setup-screen {
            position: fixed; z-index: 9999; background: #fff; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="mb-2 text-primary fw-bold">VDC CONNECT V1.6</h3>
        <p class="text-muted mb-4 small">K·ªπ thu·∫≠t: Dummy Stream Handshake</p>
        
        <button class="btn btn-primary btn-lg mb-3 w-75 shadow" onclick="initApp('streamer')">
            <i class="fas fa-camera"></i> ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG
        </button>
        <button class="btn btn-dark btn-lg w-75 shadow mb-3" onclick="initApp('viewer')">
            <i class="fas fa-eye"></i> GI√ÅM S√ÅT VI√äN
        </button>
        
        <button class="btn btn-outline-danger btn-sm mt-3" onclick="resetRoom()">
            <i class="fas fa-trash"></i> X√≥a ph√≤ng b·ªã k·∫πt
        </button>
    </div>

    <div id="main-app" class="hidden">
        
        <div id="video-wrapper">
            <video id="remote-video" autoplay playsinline class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <div id="console-log">Logs system...<br></div>

        <div id="ui-layer">
            <div class="top-bar">
                <span id="role-lbl" class="fw-bold">...</span>
                <button class="btn btn-sm btn-light" onclick="location.reload()">L√†m m·ªõi</button>
            </div>
            
            <div id="status-badge" class="status-badge st-wait">ƒêang k·∫øt n·ªëi...</div>

            <div class="bottom-controls">
                <div id="viewer-btns" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger w-100 py-3 fw-bold" onclick="sendSig('danger')">C·∫¢NH B√ÅO</button></div>
                    <div class="col-6"><button class="btn btn-success w-100 py-3 fw-bold" onclick="sendSig('safe')">X√ÅC NH·∫¨N</button></div>
                </div>
                <div id="streamer-btns" class="hidden">
                    <button id="btn-work" class="btn btn-secondary w-100 py-3 fw-bold" disabled>CH·ªú DUY·ªÜT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294",
            measurementId: "G-FTJYJ89SZH"
        };
        const ROOM_ID = "VDC_LIVE_MASTER_1";

        // === 2. INIT ===
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let peer;
        let role = '';

        function log(msg) {
            const el = document.getElementById('console-log');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        // T·∫°o Stream gi·∫£ (M√†n h√¨nh ƒëen) ƒë·ªÉ l·ª´a k·∫øt n·ªëi
        function createDummyStream() {
            const canvas = document.createElement('canvas');
            canvas.width = 10; canvas.height = 10; // Si√™u nh·∫π
            const stream = canvas.captureStream(30);
            // Th√™m track audio im l·∫∑ng (quan tr·ªçng cho m·ªôt s·ªë browser)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            stream.addTrack(dest.stream.getAudioTracks()[0]);
            return stream;
        }

        function initApp(r) {
            role = r;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('role-lbl').innerText = role === 'streamer' ? "üé• CAM" : "üëÅÔ∏è VIEW";
            
            listenSig();

            if (role === 'streamer') startStreamer();
            else startViewer();
        }

        // === 3. STREAMER (HI·ªÜN TR∆Ø·ªúNG) ===
        async function startStreamer() {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-btns').classList.remove('hidden');
            
            try {
                log("1. M·ªü Camera...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = stream;

                // STUN Google
                peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });

                peer.on('open', id => {
                    log("2. ID Streamer: " + id);
                    log("-> G·ª≠i ID l√™n Firebase...");
                    db.ref('sessions/' + ROOM_ID).update({ streamerID: id, active: true });
                });

                peer.on('call', call => {
                    log("3. Viewer ƒëang g·ªçi t·ªõi!");
                    log("-> Ch·∫•p nh·∫≠n & g·ª≠i Video...");
                    // Tr·∫£ l·ªùi cu·ªôc g·ªçi b·∫±ng Stream th·∫≠t
                    call.answer(stream);
                    
                    // Theo d√µi k·∫øt n·ªëi
                    call.peerConnection.onconnectionstatechange = () => {
                        log("Status: " + call.peerConnection.connectionState);
                    }
                });
            } catch (e) { alert("L·ªói Cam: " + e.message); }
        }

        // === 4. VIEWER (GI√ÅM S√ÅT) ===
        function startViewer() {
            document.getElementById('remote-video').classList.remove('hidden');
            document.getElementById('viewer-btns').classList.remove('hidden');

            peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', () => {
                log("1. Viewer Ready. Qu√©t ID...");
                db.ref('sessions/' + ROOM_ID).on('value', snap => {
                    const d = snap.val();
                    if (d && d.streamerID) {
                        log("2. T√¨m th·∫•y ID Streamer!");
                        connect(d.streamerID);
                    } else {
                        log("... ƒêang ch·ªù Streamer b·∫≠t m√°y ...");
                    }
                });
            });
        }

        let currentCall;
        function connect(streamerID) {
            if (currentCall) return; // Kh√¥ng g·ªçi l·∫°i n·∫øu ƒëang g·ªçi

            log("3. ƒêang t·∫°o 'Dummy Stream'...");
            const dummy = createDummyStream();

            log("4. G·ª≠i t√≠n hi·ªáu g·ªçi...");
            // QUAN TR·ªåNG: G·ª≠i dummy stream ƒëi ƒë·ªÉ k√≠ch ho·∫°t k·∫øt n·ªëi 2 chi·ªÅu
            const call = peer.call(streamerID, dummy);
            currentCall = call;

            call.on('stream', remoteStream => {
                log("5. ƒê√É NH·∫¨N ƒê∆Ø·ª¢C VIDEO TH·∫¨T!");
                const vid = document.getElementById('remote-video');
                vid.srcObject = remoteStream;
                vid.play().catch(e => {
                    log("B·ªã ch·∫∑n Autoplay -> H√£y ch·∫°m v√†o m√†n h√¨nh!");
                    alert("H√£y ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ video ch·∫°y!");
                });
            });

            call.on('error', err => log("L·ªói Call: " + err));
            
            // Monitor
            call.peerConnection.oniceconnectionstatechange = () => {
                const s = call.peerConnection.iceConnectionState;
                log("M·∫°ng P2P: " + s.toUpperCase());
                if(s === 'disconnected') {
                    log("M·∫•t k·∫øt n·ªëi! ƒêang th·ª≠ l·∫°i...");
                    location.reload();
                }
            }
        }

        // === 5. CH·ª®C NƒÇNG PH·ª§ ===
        
        // X√≥a ID c≈© tr√™n server ƒë·ªÉ tr√°nh k·∫πt
        function resetRoom() {
            if(confirm("X√≥a d·ªØ li·ªáu ph√≤ng c≈©?")) {
                db.ref('sessions/' + ROOM_ID).remove()
                  .then(() => alert("ƒê√£ x√≥a! H√£y th·ª≠ l·∫°i."))
                  .catch(e => alert("L·ªói: " + e.message));
            }
        }

        function sendSig(s) { db.ref('sessions/' + ROOM_ID + '/safe').set(s); }
        
        function listenSig() {
            const badge = document.getElementById('status-badge');
            const btn = document.getElementById('btn-work');
            db.ref('sessions/' + ROOM_ID + '/safe').on('value', snap => {
                const s = snap.val() || 'waiting';
                if(s === 'safe') {
                    badge.innerText = "ƒê∆Ø·ª¢C PH√âP"; badge.style.background = "#28a745"; badge.style.color="white";
                    btn.disabled = false; btn.innerText = "B·∫ÆT ƒê·∫¶U C√îNG VI·ªÜC"; btn.className = "btn btn-primary w-100 py-3 fw-bold";
                } else if (s === 'danger') {
                    badge.innerText = "NGUY HI·ªÇM!"; badge.style.background = "#dc3545"; badge.style.color="white";
                    btn.disabled = true; btn.innerText = "D·ª™NG L·∫†I NGAY"; btn.className = "btn btn-secondary w-100 py-3 fw-bold";
                    if(navigator.vibrate) navigator.vibrate(500);
                } else {
                    badge.innerText = "CH·ªú DUY·ªÜT"; badge.style.background = "#ffc107"; badge.style.color="black";
                    btn.disabled = true; btn.innerText = "CH·ªú DUY·ªÜT...";
                }
            });
        }
    </script>
</body>
</html>
