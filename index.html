<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC Safety V1.7</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* VIDEO CONTAINER */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; pointer-events: none; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .interactive { pointer-events: auto !important; }

        /* INFO BAR (Top) */
        .top-bar {
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center;
        }

        /* STATUS BADGES */
        .live-badge { background: red; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; animation: blink 1s infinite; }
        .queue-badge { background: #0d6efd; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; }
        @keyframes blink { 50% { opacity: 0; } }

        /* CONTROL BAR (Bottom) */
        .bottom-bar {
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 20px; text-align: center;
        }

        /* AUDIO UNLOCK OVERLAY */
        #audio-unlock {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pulse-btn { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* SETUP SCREEN */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }

        .hidden { display: none !important; }
        .btn-xl { height: 55px; font-weight: bold; font-size: 1.1rem; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h3 class="fw-bold text-primary mb-4">VDC SAFETY V1.7</h3>
        <input type="text" id="room-input" class="form-control form-control-lg mb-3 w-100 shadow-sm" style="max-width: 350px;" placeholder="Nh·∫≠p t√™n Tr·∫°m/T·ªï...">
        <div class="d-grid gap-3 w-100" style="max-width: 350px;">
            <button class="btn btn-primary btn-lg shadow" onclick="initApp('streamer')">ƒê·ªòI HI·ªÜN TR∆Ø·ªúNG</button>
            <button class="btn btn-dark btn-lg shadow" onclick="initApp('viewer')">GI√ÅM S√ÅT VI√äN</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="video-container">
            <video id="remote-video" autoplay playsinline muted class="hidden"></video>
            <video id="local-video" autoplay playsinline muted class="hidden"></video>
        </div>

        <div id="audio-unlock" class="hidden interactive">
            <h2 class="text-white fw-bold mb-3" id="station-name-display">...</h2>
            <button class="btn btn-success btn-lg rounded-pill px-5 py-4 shadow pulse-btn" onclick="unlockAudio()">
                <i class="fas fa-volume-up fa-2x"></i><br>B·∫§M ƒê·ªÇ NGHE & XEM
            </button>
        </div>

        <div id="ui-layer">
            <div class="top-bar interactive">
                <div>
                    <span id="live-indicator" class="live-badge hidden">LIVE</span>
                    <span id="queue-indicator" class="queue-badge hidden">ƒêang l∆∞u: 0</span>
                    <span id="room-lbl" class="text-white fw-bold ms-2 text-uppercase">...</span>
                </div>
                <a id="drive-link" href="#" target="_blank" class="btn btn-sm btn-outline-light hidden">
                    <i class="fab fa-google-drive"></i> Folder H·ªì S∆°
                </a>
            </div>

            <div class="bottom-bar interactive">
                <div id="viewer-btns" class="hidden row g-2">
                    <div class="col-6"><button class="btn btn-danger btn-xl w-100 shadow" onclick="sendCmd('danger')">C·∫¢NH B√ÅO</button></div>
                    <div class="col-6"><button class="btn btn-success btn-xl w-100 shadow" onclick="sendCmd('safe')">X√ÅC NH·∫¨N</button></div>
                </div>

                <div id="streamer-btns" class="hidden">
                    <button class="btn btn-danger btn-xl w-100 shadow mb-2" onclick="finishWork()">
                        <i class="fas fa-stop-circle"></i> K·∫æT TH√öC C√îNG VI·ªÜC
                    </button>
                    <button id="status-display" class="btn btn-secondary w-100" disabled>ƒêang ch·ªù t√≠n hi·ªáu...</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfbO0QC6-uklzUOMpuGKJkm_lU-RNuGVSO30zBZWFj6a3z3nWIydcLCNESO89q1Hq-HQ/exec";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa_tWnugqGRTM5nL-I9n4iIFgv1JIIUIc",
            authDomain: "livestream-2e250.firebaseapp.com",
            projectId: "livestream-2e250",
            storageBucket: "livestream-2e250.firebasestorage.app",
            messagingSenderId: "151196286205",
            appId: "1:151196286205:web:c06c4fe1745fee7a5ed294"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let peer, ROOM_ID = '', role = '', SESSION_FOLDER_NAME = '';
        let mediaRecorder;
        
        // H√†ng ƒë·ª£i Upload (Upload Queue)
        let uploadQueue = [];
        let isUploading = false;
        let partIndex = 1;

        // === INIT ===
        function initApp(r) {
            const input = document.getElementById('room-input').value.trim();
            if(!input) return alert("Vui l√≤ng nh·∫≠p t√™n Tr·∫°m!");
            
            ROOM_ID = "VDC_" + input.replace(/[^a-zA-Z0-9]/g, "_").toUpperCase();
            // T√™n th∆∞ m·ª•c tr√™n Drive: TRAM_ABC_08h30_24_01
            let now = new Date();
            let timeStr = `${now.getHours()}h${now.getMinutes()}_${now.getDate()}_${now.getMonth()+1}`;
            SESSION_FOLDER_NAME = `${ROOM_ID}_${timeStr}`;

            role = r;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('room-lbl').innerText = input;

            if (role === 'streamer') startStreamer();
            else startViewer();
        }

        // ==========================================
        // 1. STREAMER LOGIC (LIVESTREAM + CHUNKING)
        // ==========================================
        async function startStreamer() {
            document.getElementById('local-video').classList.remove('hidden');
            document.getElementById('streamer-btns').classList.remove('hidden');

            try {
                // Video c·∫•u h√¨nh nh·∫π ƒë·ªÉ nh·∫π m·∫°ng (480p)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = stream;

                // 1. B·∫ÆT ƒê·∫¶U C·∫ÆT G√ìI & UPLOAD
                startChunkRecording(stream);

                // 2. PH√ÅT LIVESTREAM P2P
                peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
                peer.on('open', id => {
                    db.ref('vdc_ops/' + ROOM_ID).set({
                        streamerID: id,
                        status: 'live',
                        folderName: SESSION_FOLDER_NAME, // G·ª≠i t√™n folder cho Gi√°m s√°t bi·∫øt
                        driveUrl: '' // S·∫Ω c·∫≠p nh·∫≠t khi c√≥ file ƒë·∫ßu ti√™n
                    });
                    // T·ª± ƒë·ªông b√°o offline khi m·∫•t m·∫°ng
                    db.ref('vdc_ops/' + ROOM_ID).onDisconnect().update({ status: 'offline' });
                });
                peer.on('call', call => call.answer(stream));

                listenSignal(); // Nghe l·ªánh An to√†n

            } catch(e) { alert("L·ªói Camera: " + e.message); }
        }

        function startChunkRecording(stream) {
            // C·∫Øt m·ªói 10 gi√¢y (10000ms)
            let options = { mimeType: 'video/webm;codecs=vp8', videoBitsPerSecond: 250000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };

            mediaRecorder = new MediaRecorder(stream, options);
            
            mediaRecorder.ondataavailable = e => {
                if(e.data.size > 0) {
                    // ƒê·∫©y v√†o h√†ng ƒë·ª£i
                    uploadQueue.push({ blob: e.data, index: partIndex++ });
                    updateQueueUI();
                    processQueue(); // K√≠ch ho·∫°t x·ª≠ l√Ω h√†ng ƒë·ª£i
                }
            };
            
            mediaRecorder.start(10000); // C·∫Øt m·ªói 10s
            document.getElementById('live-indicator').classList.remove('hidden');
        }

        // X·ª≠ l√Ω h√†ng ƒë·ª£i: T·∫£i l√™n t·ª´ng file m·ªôt
        function processQueue() {
            if (isUploading || uploadQueue.length === 0) return;
            
            isUploading = true;
            const item = uploadQueue[0]; // L·∫•y item ƒë·∫ßu ti√™n
            
            // Convert Blob to Base64
            const reader = new FileReader();
            reader.readAsDataURL(item.blob);
            reader.onloadend = function() {
                const base64data = reader.result.split(',')[1];
                // T√™n file: part_001.webm
                const fileName = `part_${String(item.index).padStart(3, '0')}.webm`;

                // G·ª≠i l√™n AppScript
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Quan tr·ªçng
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileData: base64data,
                        fileName: fileName,
                        mimeType: 'video/webm',
                        folderName: SESSION_FOLDER_NAME // G·ª≠i k√®m t√™n Folder ƒë·ªÉ Server bi·∫øt b·ªè v√†o ƒë√¢u
                    })
                })
                .then(() => {
                    // Gi·∫£ l·∫≠p th√†nh c√¥ng (do no-cors kh√¥ng ƒë·ªçc ƒë∆∞·ª£c response)
                    console.log("Uploaded chunk " + item.index);
                    uploadQueue.shift(); // X√≥a kh·ªèi h√†ng ƒë·ª£i
                    isUploading = false;
                    updateQueueUI();
                    
                    // N·∫øu l√† g√≥i ƒë·∫ßu ti√™n, ta gi·∫£ ƒë·ªãnh folder ƒë√£ t·∫°o xong (sau v√†i gi√¢y)
                    // (Th·ª±c t·∫ø AppScript tr·∫£ v·ªÅ link, nh∆∞ng no-cors kh√¥ng ƒë·ªçc ƒë∆∞·ª£c. 
                    // Ta s·∫Ω ƒë·ªÉ Gi√°m s√°t t·ª± v√†o Drive t·ªïng t√¨m folder t√™n SESSION_FOLDER_NAME)
                    
                    processQueue(); // L√†m ti·∫øp c√°i sau
                })
                .catch(err => {
                    console.error("Upload error", err);
                    isUploading = false;
                    // Th·ª≠ l·∫°i sau 5s
                    setTimeout(processQueue, 5000);
                });
            };
        }

        function updateQueueUI() {
            const el = document.getElementById('queue-indicator');
            if (uploadQueue.length > 0) {
                el.classList.remove('hidden');
                el.innerText = `ƒêang l∆∞u: ${uploadQueue.length} g√≥i`;
            } else {
                el.classList.add('hidden');
            }
        }

        function finishWork() {
            if(confirm("K·∫øt th√∫c v√† d·ª´ng ghi h√¨nh?")) {
                if(mediaRecorder) mediaRecorder.stop();
                db.ref('vdc_ops/' + ROOM_ID).update({ status: 'ended' });
                alert("ƒê√£ k·∫øt th√∫c. C√°c ph·∫ßn video c√≤n l·∫°i trong h√†ng ƒë·ª£i s·∫Ω ti·∫øp t·ª•c ƒë∆∞·ª£c t·∫£i l√™n ng·∫ßm.");
                document.getElementById('streamer-btns').classList.add('hidden');
            }
        }

        // ==========================================
        // 2. VIEWER LOGIC (LIVE P2P + DRIVE LINK)
        // ==========================================
        function startViewer() {
            document.getElementById('audio-unlock').classList.remove('hidden');
            document.getElementById('station-name-display').innerText = ROOM_ID.replace('VDC_', '');
            
            initPeerViewer();
        }

        function initPeerViewer() {
            peer = new Peer({ config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });
            peer.on('open', () => {
                db.ref('vdc_ops/' + ROOM_ID).on('value', snap => {
                    const d = snap.val();
                    if (d && d.streamerID) {
                        connectToStreamer(d.streamerID);
                        
                        // Hi·ªÉn th·ªã t√™n Folder Drive (n·∫øu c·∫ßn)
                        // ·ªû ƒë√¢y ta ch∆∞a c√≥ Link tr·ª±c ti·∫øp do no-cors, 
                        // nh∆∞ng c√≥ th·ªÉ hi·ªÉn th·ªã n√∫t ƒë·ªÉ Gi√°m s√°t bi·∫øt video ƒëang ƒë∆∞·ª£c l∆∞u
                        if(d.folderName) {
                            const linkBtn = document.getElementById('drive-link');
                            linkBtn.classList.remove('hidden');
                            // ƒê√¢y l√† link v√†o th∆∞ m·ª•c G·ªëc, Gi√°m s√°t t·ª± t√¨m folder con
                            // (Ho·∫∑c n·∫øu b·∫°n c·∫•u h√¨nh AppScript tr·∫£ v·ªÅ URL public v√†o DB th√¨ t·ªët h∆°n)
                            linkBtn.href = "https://drive.google.com/drive/u/0/folders/11GBcLqK2ggbntyRLt-ID23YLYzZWWON2"; 
                            linkBtn.innerText = "üìÅ M·ªü Drive: " + d.folderName;
                        }
                    }
                });
            });
        }

        // K·ª∏ THU·∫¨T DUMMY STREAM V1.6 (ƒê·ªÇ C√ì TI·∫æNG)
        let currConn;
        function connectToStreamer(id) {
            if (currConn) return;
            const canvas = document.createElement('canvas'); 
            const dummy = canvas.captureStream(10);
            const call = peer.call(id, dummy);
            currConn = call;

            call.on('stream', stream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = stream;
            });
        }

        function unlockAudio() {
            const vid = document.getElementById('remote-video');
            vid.muted = false;
            vid.play().then(() => {
                document.getElementById('audio-unlock').classList.add('hidden');
                document.getElementById('remote-video').classList.remove('hidden');
                document.getElementById('viewer-btns').classList.remove('hidden');
            }).catch(e => alert("Vui l√≤ng th·ª≠ l·∫°i."));
        }

        // ==========================================
        // 3. T√çN HI·ªÜU AN TO√ÄN
        // ==========================================
        function sendCmd(type) {
            db.ref('vdc_ops/' + ROOM_ID).update({ signal: type });
        }

        function listenSignal() {
            db.ref('vdc_ops/' + ROOM_ID + '/signal').on('value', snap => {
                const s = snap.val();
                const btn = document.getElementById('status-display');
                if(s === 'safe') {
                    btn.className = "btn btn-primary w-100 fw-bold";
                    btn.innerText = "ƒê√É DUY·ªÜT AN TO√ÄN";
                } else if(s === 'danger') {
                    btn.className = "btn btn-danger w-100 fw-bold";
                    btn.innerText = "C·∫¢NH B√ÅO NGUY HI·ªÇM!";
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                }
            });
        }
    </script>
</body>
</html>
